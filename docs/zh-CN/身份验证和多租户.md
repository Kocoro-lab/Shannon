# Shannon 身份验证和多租户系统

## 概述

Shannon 实现了**生产就绪的身份验证和多租户系统**，提供企业级安全性，在组织之间实现完全的数据隔离。该系统使用 JWT 令牌进行用户会话管理，使用 API 密钥进行程序化访问，并在所有数据存储中实现完整的租户隔离。

## 架构

### 身份验证流程
```
用户注册 → 租户创建 → JWT 生成 → 经过身份验证的请求
                ↓
          组织隔离（租户 ID）
                ↓
      会话、任务、工作流、向量内存
```

### 关键组件

1. **JWT 身份验证**：短期访问令牌（30 分钟）和刷新令牌（7 天）
2. **API 密钥**：用于程序化访问的长期令牌，具有可配置的作用域
3. **多租户**：每一层的组织之间完全隔离
4. **基于角色的访问**：三层系统（所有者、管理员、用户）
5. **审计日志**：用于合规性的全面活动跟踪

## 实施状态 ✅

### 核心身份验证
- ✅ 支持租户的数据库模式
- ✅ JWT 令牌生成和验证
- ✅ API 密钥管理系统
- ✅ 使用 bcrypt 的密码哈希
- ✅ HTTP 端点（注册/登录）
- ✅ gRPC 中间件强制执行
- ✅ 通过 shannon.yaml 配置

### 多租户强制执行
- ✅ **会话**：Redis 和 PostgreSQL 按 tenant_id 过滤
- ✅ **任务**：工作流备忘录检查防止跨租户访问
- ✅ **向量内存**：Qdrant 查询按租户元数据过滤
- ✅ **工作流**：租户上下文贯穿所有操作
- ✅ **数据库**：tenant_id 列和查询过滤

## 快速开始

### 1. 启用身份验证

```yaml
# config/shannon.yaml
auth:
  enabled: true
  skip_auth: false
  jwt_secret: "your-secure-32-character-minimum-secret"
  access_token_expiry: "30m"
  refresh_token_expiry: "168h"
```

### 2. 注册用户

```bash
curl -X POST http://localhost:8081/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "username": "johndoe",
    "password": "SecurePass123!",
    "full_name": "John Doe"
  }'
```

响应：
```json
{
  "user": {
    "id": "user-uuid",
    "email": "user@example.com",
    "username": "johndoe",
    "tenant_id": "tenant-uuid",
    "role": "user"
  }
}
```

### 3. 登录

```bash
curl -X POST http://localhost:8081/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "SecurePass123!"
  }'
```

响应：
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "refresh_token": "refresh_token_string",
  "token_type": "Bearer",
  "expires_in": 1800
}
```

### 4. 进行经过身份验证的请求

#### 使用 JWT 的 gRPC
```bash
grpcurl -plaintext \
  -H "authorization: Bearer <access_token>" \
  -d '{"query":"Hello Shannon"}' \
  localhost:50052 shannon.orchestrator.OrchestratorService/SubmitTask
```

#### 使用 API 密钥的 HTTP
```bash
# 通过网关（推荐用于 HTTP）
curl -X POST http://localhost:8080/api/v1/tasks \
  -H "X-API-Key: sk_test_123456" \
  -H "Content-Type: application/json" \
  -d '{"query":"Hello Shannon"}'
```

## 多租户设计

### 租户隔离层

1. **身份验证层**
   - 每个用户恰好属于一个租户
   - 租户 ID 嵌入在 JWT 声明中
   - API 密钥限定为租户

2. **会话层**
   - 会话使用 tenant_id 标记
   - GetSession 强制执行租户匹配
   - 会话查询按租户过滤

3. **工作流层**
   - 租户 ID 通过工作流输入传递
   - 存储在工作流备忘录中以实现持久性
   - GetTaskStatus 验证租户所有权

4. **向量数据库层**
   - 所有向量包含 tenant_id 元数据
   - 使用 Qdrant must 条件过滤查询
   - 租户之间的完全内存隔离

5. **数据库层**
   - tasks 和 sessions 表中的 tenant_id 列
   - WHERE 子句强制执行租户过滤
   - 不可能进行跨租户数据访问

### 安全保证

- **无数据泄漏**：即使知道 ID，用户也无法访问其他租户的数据
- **静默失败**：跨租户访问尝试返回"未找到"（无存在泄漏）
- **完全隔离**：每个数据操作都限定于租户
- **审计跟踪**：记录所有访问尝试以确保合规性

## 数据库模式

```sql
-- 租户（组织）
CREATE TABLE auth.tenants (
    id UUID PRIMARY KEY,
    name VARCHAR(255),
    slug VARCHAR(100) UNIQUE,
    plan VARCHAR(50), -- free, pro, enterprise
    token_limit INTEGER,
    is_active BOOLEAN
);

-- 用户
CREATE TABLE auth.users (
    id UUID PRIMARY KEY,
    email VARCHAR(255) UNIQUE,
    username VARCHAR(100) UNIQUE,
    password_hash VARCHAR(255),
    tenant_id UUID REFERENCES auth.tenants(id),
    role VARCHAR(50), -- owner, admin, user
    is_active BOOLEAN
);

-- 具有租户隔离的会话
CREATE TABLE sessions (
    id VARCHAR(255) PRIMARY KEY,
    user_id VARCHAR(255),
    tenant_id UUID,
    created_at TIMESTAMP,
    metadata JSONB
);

-- 具有租户隔离的任务执行
CREATE TABLE task_executions (
    id UUID PRIMARY KEY,
    workflow_id VARCHAR(255) UNIQUE NOT NULL,
    user_id UUID,
    tenant_id UUID,
    status VARCHAR(50),
    created_at TIMESTAMP
);
```

## API 参考

### 身份验证端点

| 端点 | 方法 | 描述 |
|------|------|------|
| `/api/auth/register` | POST | 注册新用户 |
| `/api/auth/login` | POST | 登录并获取令牌 |
| `/api/auth/refresh` | POST | 刷新访问令牌（待办） |
| `/api/auth/logout` | POST | 撤销令牌（待办） |

### 必需的头部

| 服务 | 头部 | 格式 |
|------|------|------|
| gRPC | `authorization` | `Bearer <jwt_token>` |
| gRPC | `x-api-key` | `<api_key>` |
| HTTP | `Authorization` | `Bearer <jwt_token>` |
| HTTP | `X-API-Key` | `<api_key>` |

## 配置

### 完整配置选项

```yaml
auth:
  enabled: true                    # 启用身份验证系统
  skip_auth: false                 # 开发模式绕过
  jwt_secret: "32-char-minimum"    # JWT 签名密钥
  access_token_expiry: "30m"       # 访问令牌生命周期
  refresh_token_expiry: "168h"     # 刷新令牌生命周期（7 天）
  api_key_rate_limit: 1000         # 每个 API 密钥每小时的请求数
  default_tenant_limit: 10000      # 新租户的默认令牌限制
  enable_registration: true        # 允许自助注册
  require_email_verification: false # 电子邮件验证（未来）
```

### 环境变量

```bash
# 覆盖配置文件设置
export AUTH_ENABLED=true
export AUTH_JWT_SECRET="your-production-secret"
export AUTH_SKIP_AUTH=false
```

## 开发和测试

### 开发模式

对于无身份验证的开发：
```yaml
auth:
  skip_auth: true  # 绕过所有身份验证检查
```

### 测试多租户

```bash
# 在不同租户中注册用户
./scripts/test-multitenancy.sh

# 验证隔离
# 1. 用户 A 创建数据
# 2. 用户 B 无法访问用户 A 的数据
# 3. 两个用户都有隔离的会话和内存
```

## 迁移指南

### 从未经身份验证到经过身份验证

1. **运行数据库迁移**
```bash
docker exec shannon-postgres-1 psql -U shannon -d shannon \
  -f /docker-entrypoint-initdb.d/003_authentication.sql
```

2. **更新配置**
```yaml
auth:
  enabled: true
  skip_auth: false
  jwt_secret: "production-secret-min-32-chars"
```

3. **重启服务**
```bash
docker compose -f deploy/compose/docker-compose.yml restart orchestrator
```

4. **创建初始管理员**
```bash
# 使用默认管理员或通过 API 创建
curl -X POST http://localhost:8081/api/auth/register ...
```

## 安全最佳实践

1. **JWT 密钥管理**
   - 使用密码学安全的 32+ 字符密钥
   - 存储在环境变量或密钥管理器中
   - 定期轮换

2. **API 密钥管理**
   - 为每个应用程序/服务生成唯一密钥
   - 为临时访问设置过期日期
   - 通过审计日志监控使用情况

3. **租户隔离**
   - 永远不要向用户公开内部租户 ID
   - 对面向用户的标识符使用租户 slug
   - 定期审计跨租户访问尝试

4. **生产部署**
   - 始终使用 HTTPS/TLS
   - 启用速率限制
   - 适当配置 CORS
   - 为关键操作实施请求签名

## 故障排除

### 常见问题

**"令牌无效"错误**
- 验证 JWT 密钥在服务之间匹配
- 检查令牌过期
- 确保头部中有"Bearer "前缀

**有效任务显示"任务未找到"**
- 可能是租户不匹配
- 验证用户的 tenant_id 与任务的 tenant_id 匹配
- 检查工作流备忘录中的租户上下文

**会话不持久**
- 验证 Redis 连接
- 检查会话 TTL 配置
- 确保正在传递 tenant_id

### 调试日志

启用身份验证调试日志：
```yaml
logging:
  level: debug
  components:
    auth: debug
    session: debug
```

## 与其他平台的比较

| 功能 | Shannon | LangGraph | Dify | Flowise |
|------|---------|-----------|------|---------|
| JWT 身份验证 | ✅ | ✅ | ✅ | ✅ |
| API 密钥 | ✅ | ✅ | ✅ | ✅ |
| 多租户 | ✅ 完整 | ⚠️ 部分 | ✅ | ⚠️ 仅 UI |
| 会话隔离 | ✅ | ✅ | ✅ | ❌ |
| 向量隔离 | ✅ | ❌ | ⚠️ | ❌ |
| 审计日志 | ✅ | ⚠️ | ✅ | ❌ |

## 未来增强

- [ ] OAuth2 提供商（Google、GitHub、Microsoft）
- [ ] 用于企业 SSO 的 SAML 2.0
- [ ] 双因素身份验证（2FA）
- [ ] 刷新令牌端点
- [ ] 用于用户管理的管理 CLI
- [ ] 租户使用分析仪表板
- [ ] 细粒度权限（资源级别）
- [ ] API 密钥轮换策略

## 支持

对于问题或疑问：
1. 检查审计日志：`docker logs shannon-orchestrator-1`
2. 验证配置：`cat config/shannon.yaml`
3. 使用上面的 curl/grpcurl 示例测试
4. 在 GitHub 上提交问题并附带错误详细信息

---

*最后更新：2025 年 1 月*

