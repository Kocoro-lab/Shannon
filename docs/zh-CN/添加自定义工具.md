# å‘ Shannon æ·»åŠ è‡ªå®šä¹‰å·¥å…·

**å¼€æºé‡‡ç”¨è€…æ‰©å±• Shannon è‡ªå®šä¹‰å·¥å…·çš„å®Œæ•´æŒ‡å—**

---

## ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [å¿«é€Ÿå¼€å§‹ï¼šæ·»åŠ  MCP å·¥å…·](#å¿«é€Ÿå¼€å§‹æ·»åŠ -mcp-å·¥å…·)
3. [æ·»åŠ  OpenAPI å·¥å…·](#æ·»åŠ -openapi-å·¥å…·)
4. [æ·»åŠ å†…ç½® Python å·¥å…·](#æ·»åŠ å†…ç½®-python-å·¥å…·)
5. [é…ç½®å‚è€ƒ](#é…ç½®å‚è€ƒ)
6. [æµ‹è¯•ä¸éªŒè¯](#æµ‹è¯•ä¸éªŒè¯)
7. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
8. [å®‰å…¨æœ€ä½³å®è·µ](#å®‰å…¨æœ€ä½³å®è·µ)

---

## æ¦‚è¿°

Shannon æ”¯æŒä¸‰ç§æ·»åŠ è‡ªå®šä¹‰å·¥å…·çš„æ–¹å¼ï¼š

| æ–¹æ³• | æœ€é€‚ç”¨äº | ä»£ç ä¿®æ”¹ | éœ€è¦é‡å¯ |
|------|---------|----------|---------|
| **MCP å·¥å…·** | å¤–éƒ¨ HTTP APIï¼Œå¿«é€ŸåŸå‹å¼€å‘ | æ—  | âœ… ä»…æœåŠ¡ |
| **OpenAPI å·¥å…·** | å…·æœ‰ OpenAPI è§„èŒƒçš„ REST API | æ—  | âœ… ä»…æœåŠ¡ |
| **å†…ç½®å·¥å…·** | å¤æ‚é€»è¾‘ï¼Œæ•°æ®åº“è®¿é—®ï¼Œæ€§èƒ½è¦æ±‚é«˜ | Python ä»£ç  | âœ… ä»…æœåŠ¡ |

**ä¸»è¦ç‰¹æ€§ï¼š**
- âœ… æ— éœ€ä¿®æ”¹ Proto/Rust/Goï¼ˆæ‰€æœ‰å·¥å…·ä½¿ç”¨é€šç”¨å®¹å™¨ï¼‰
- âœ… é€šè¿‡ API æˆ– YAML é…ç½®åŠ¨æ€æ³¨å†Œ
- âœ… å†…ç½®é€Ÿç‡é™åˆ¶å’Œç†”æ–­å™¨
- âœ… åŸŸåç™½åå•å®‰å…¨æ§åˆ¶
- âœ… æˆæœ¬è·Ÿè¸ªå’Œé¢„ç®—æ§åˆ¶

---

## å¿«é€Ÿå¼€å§‹ï¼šæ·»åŠ  MCP å·¥å…·

MCPï¼ˆModel Context Protocolï¼‰å·¥å…·è®©ä½ æ— éœ€ä¿®æ”¹ä»£ç å³å¯å°†ä»»ä½• HTTP ç«¯ç‚¹é›†æˆä¸º Shannon å·¥å…·ã€‚

### æ­¥éª¤ 1: æ·»åŠ å·¥å…·å®šä¹‰

ç¼–è¾‘ `config/shannon.yaml` ä¸­çš„ `mcp_tools` éƒ¨åˆ†ï¼š

```yaml
mcp_tools:
  weather_forecast:
    enabled: true
    url: "https://api.weather.com/v1/forecast"
    func_name: "get_weather"
    description: "è·å–æŒ‡å®šä½ç½®çš„å¤©æ°”é¢„æŠ¥"
    category: "data"
    cost_per_use: 0.001
    parameters:
      - name: "location"
        type: "string"
        required: true
        description: "åŸå¸‚åç§°æˆ–åæ ‡"
      - name: "units"
        type: "string"
        required: false
        description: "æ¸©åº¦å•ä½ (celsius/fahrenheit)"
        enum: ["celsius", "fahrenheit"]
    headers:
      X-API-Key: "${WEATHER_API_KEY}"  # ä» .env è§£æ
```

**å¿…å¡«å­—æ®µï¼š**
- `enabled`: è®¾ç½®ä¸º `true` ä»¥æ¿€æ´»
- `url`: HTTP ç«¯ç‚¹ï¼ˆå¿…é¡»æ˜¯ POSTï¼Œæ¥å— JSONï¼‰
- `func_name`: å†…éƒ¨å‡½æ•°åç§°
- `description`: å‘ LLM å±•ç¤ºçš„æ¸…æ™°æè¿°
- `category`: å·¥å…·ç±»åˆ«ï¼ˆå¦‚ `search`ã€`data`ã€`analytics`ã€`code`ï¼‰
- `cost_per_use`: é¢„ä¼°æˆæœ¬ï¼ˆç¾å…ƒï¼‰
- `parameters`: å‚æ•°å®šä¹‰æ•°ç»„

**å¯é€‰å­—æ®µï¼š**
- `headers`: ç”¨äºèº«ä»½éªŒè¯çš„ HTTP å¤´ï¼ˆä½¿ç”¨ `${ENV_VAR}` å¼•ç”¨ç¯å¢ƒå˜é‡ï¼‰

### æ­¥éª¤ 2: é…ç½®åŸŸåè®¿é—®

**å¼€å‘ç¯å¢ƒï¼ˆå®½æ¾ï¼‰ï¼š**

æ·»åŠ åˆ° `.env`ï¼š
```bash
MCP_ALLOWED_DOMAINS=*  # é€šé…ç¬¦ - å…è®¸æ‰€æœ‰åŸŸå
```

**ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰ï¼š**

```bash
MCP_ALLOWED_DOMAINS=localhost,127.0.0.1,api.weather.com,api.example.com
```

æˆ–åœ¨ `deploy/compose/docker-compose.yml` ä¸­è®¾ç½®ï¼š
```yaml
services:
  llm-service:
    environment:
      - MCP_ALLOWED_DOMAINS=api.weather.com,api.stocks.com
```

### æ­¥éª¤ 3: æ·»åŠ  API å¯†é’¥

å°† API å¯†é’¥æ·»åŠ åˆ° `.env`ï¼š

```bash
# MCP å·¥å…· API å¯†é’¥
WEATHER_API_KEY=your_api_key_here
STOCK_API_KEY=your_stock_key_here
```

### æ­¥éª¤ 4: é‡å¯æœåŠ¡

**é‡è¦ï¼š** å¿…é¡»**é‡æ–°åˆ›å»º**æœåŠ¡ï¼ˆè€Œä¸åªæ˜¯é‡å¯ï¼‰ï¼š

```bash
docker compose -f deploy/compose/docker-compose.yml up -d --force-recreate llm-service
```

ç­‰å¾…å¥åº·æ£€æŸ¥ï¼š
```bash
docker inspect shannon-llm-service-1 --format='{{.State.Health.Status}}'
```

### æ­¥éª¤ 5: éªŒè¯æ³¨å†Œ

æ£€æŸ¥æ—¥å¿—ï¼š
```bash
docker compose logs llm-service | grep "Loaded MCP tool"
```

é€šè¿‡ API åˆ—å‡ºå·¥å…·ï¼š
```bash
curl http://localhost:8000/tools/list | jq .
```

è·å–å·¥å…·æ¨¡å¼ï¼š
```bash
curl http://localhost:8000/tools/weather_forecast/schema | jq .
```

### æ­¥éª¤ 6: æµ‹è¯•å·¥å…·

**ç›´æ¥æ‰§è¡Œï¼š**
```bash
curl -X POST http://localhost:8000/tools/execute \
  -H "Content-Type: application/json" \
  -d '{
    "tool_name": "weather_forecast",
    "parameters": {"location": "Tokyo", "units": "celsius"}
  }'
```

**é€šè¿‡å·¥ä½œæµï¼š**
```bash
SESSION_ID="test-$(date +%s)" ./scripts/submit_task.sh "ä¸œäº¬çš„å¤©æ°”é¢„æŠ¥æ˜¯ä»€ä¹ˆï¼Ÿ"
```

### å¤‡é€‰æ–¹æ¡ˆï¼šè¿è¡Œæ—¶ API æ³¨å†Œ

ä»…ç”¨äºå¼€å‘/æµ‹è¯•ï¼ˆé‡å¯åå·¥å…·ä¼šä¸¢å¤±ï¼‰ï¼š

```bash
# åœ¨ .env ä¸­è®¾ç½®ç®¡ç†å‘˜ä»¤ç‰Œ
MCP_REGISTER_TOKEN=your_secret_token

# æ³¨å†Œå·¥å…·
curl -X POST http://localhost:8000/tools/mcp/register \
  -H "Authorization: Bearer your_secret_token" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "weather_forecast",
    "url": "https://api.weather.com/v1/forecast",
    "func_name": "get_weather",
    "description": "è·å–å¤©æ°”é¢„æŠ¥",
    "category": "data",
    "parameters": [
      {"name": "location", "type": "string", "required": true},
      {"name": "units", "type": "string", "enum": ["celsius", "fahrenheit"]}
    ]
  }'
```

### MCP è¯·æ±‚çº¦å®š

Shannon ä»¥æ­¤æ ¼å¼å‘é€ POST è¯·æ±‚ï¼š

```json
{
  "function": "get_weather",
  "args": {
    "location": "Tokyo",
    "units": "celsius"
  }
}
```

ä½ çš„ç«¯ç‚¹åº”è¿”å› JSONï¼š
```json
{
  "temperature": 18,
  "condition": "Cloudy",
  "humidity": 65
}
```

---

## æ·»åŠ  OpenAPI å·¥å…·

å¯¹äºå…·æœ‰ OpenAPI 3.x è§„èŒƒçš„ REST APIï¼ŒShannon å¯ä»¥è‡ªåŠ¨ç”Ÿæˆå·¥å…·ã€‚

### åŠŸèƒ½ç‰¹æ€§

**æ”¯æŒçš„åŠŸèƒ½ï¼š**
- âœ… OpenAPI 3.0 å’Œ 3.1 è§„èŒƒ
- âœ… åŸºäº URL æˆ–å†…è”è§„èŒƒåŠ è½½
- âœ… JSON è¯·æ±‚/å“åº”ä½“
- âœ… è·¯å¾„å’ŒæŸ¥è¯¢å‚æ•°
- âœ… Bearerã€API Keyï¼ˆheader/queryï¼‰ã€Basic è®¤è¯
- âœ… é€šè¿‡ operationId æˆ– tags è¿‡æ»¤æ“ä½œ
- âœ… ç†”æ–­å™¨ï¼ˆ5 æ¬¡å¤±è´¥ â†’ 60 ç§’å†·å´ï¼‰
- âœ… æŒ‡æ•°é€€é¿é‡è¯•é€»è¾‘ï¼ˆ3 æ¬¡é‡è¯•ï¼Œå¯é€šè¿‡ `OPENAPI_RETRIES` é…ç½®ï¼‰
- âœ… å¯é…ç½®çš„é€Ÿç‡é™åˆ¶å’Œè¶…æ—¶
- âœ… ç›¸å¯¹æœåŠ¡å™¨ URLï¼ˆæ ¹æ®è§„èŒƒ URL è§£æï¼‰
- âœ… åŸºæœ¬ `$ref` è§£æï¼ˆæœ¬åœ°å¼•ç”¨ `#/components/schemas/*`ï¼‰

**é™åˆ¶ï¼ˆMVPï¼‰ï¼š**

Shannon OpenAPI é›†æˆå¯¹çº¦ 70% çš„ REST APIï¼ˆåŸºäº JSON å’Œç®€å•è®¤è¯ï¼‰å·²è¾¾åˆ°ç”Ÿäº§å°±ç»ªã€‚ä»¥ä¸‹åŠŸèƒ½**å°šæœªæ”¯æŒï¼š**

1. **âŒ æ–‡ä»¶ä¸Šä¼  API (multipart/form-data)**
   - æ— æ³•ä¸Šä¼ æ–‡ä»¶æˆ–äºŒè¿›åˆ¶æ•°æ®
   - è§£å†³æ–¹æ¡ˆï¼šåœ¨ JSON ä½“ä¸­ä½¿ç”¨ base64 ç¼–ç æ–‡ä»¶
   - å—å½±å“çš„ APIï¼šå›¾åƒç”Ÿæˆã€æ–‡ä»¶å¤„ç†ã€æ–‡æ¡£ä¸Šä¼  API

2. **âŒ OAuth ä¿æŠ¤çš„ API**
   - ä¸æ”¯æŒ OAuth 2.0 æµç¨‹ï¼ˆæˆæƒç ã€å®¢æˆ·ç«¯å‡­è¯ï¼‰
   - åªèƒ½ä½¿ç”¨ Bearer ä»¤ç‰Œï¼ˆæ‰‹åŠ¨è·å–ï¼‰
   - å—å½±å“çš„ APIï¼šGoogle APIsã€GitHubã€Slackã€Twitter ç­‰
   - è§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨è·å– OAuth ä»¤ç‰Œå¹¶ä½¿ç”¨ `bearer` auth_type

3. **âŒ å¤æ‚å‚æ•°ç¼–ç **
   - ä¸æ”¯æŒ `style`ã€`explode` æˆ– `deepObject` åºåˆ—åŒ–
   - ä»…åŸºæœ¬è·¯å¾„/æŸ¥è¯¢å‚æ•°æ›¿æ¢
   - å—å½±å“çš„ APIï¼šå…·æœ‰å¤æ‚æ•°ç»„/å¯¹è±¡æŸ¥è¯¢å‚æ•°çš„ API

4. **âŒ å¤šæ–‡ä»¶ OpenAPI è§„èŒƒ**
   - ä¸æ”¯æŒè¿œç¨‹ `$ref` è§£æï¼ˆå¦‚ `https://example.com/schemas/Pet.json`ï¼‰
   - ä»…æ”¯æŒæœ¬åœ°å¼•ç”¨ï¼ˆ`#/components/...`ï¼‰
   - è§£å†³æ–¹æ¡ˆï¼šå°†å¤–éƒ¨æ¨¡å¼åˆå¹¶åˆ°å•ä¸ªè§„èŒƒæ–‡ä»¶

5. **âŒ é«˜çº§æ¨¡å¼ç»„åˆå™¨**
   - ä¸æ”¯æŒ `allOf`ã€`oneOf`ã€`anyOf`
   - ä»…åŸºæœ¬ç±»å‹æ˜ å°„
   - å—å½±å“çš„ APIï¼šå…·æœ‰å¤šæ€ç±»å‹æˆ–å¤æ‚éªŒè¯çš„ API

6. **âŒ è¡¨å•ç¼–ç è¯·æ±‚**
   - ä¸æ”¯æŒ `application/x-www-form-urlencoded` å†…å®¹ç±»å‹
   - ä»…æ”¯æŒ JSON è¯·æ±‚ä½“

**è¿è¡Œè‰¯å¥½çš„åœºæ™¯ï¼š**
- âœ… å…·æœ‰ JSON è¯·æ±‚/å“åº”çš„ç®€å• REST API
- âœ… ä½¿ç”¨ Bearer/API Key/Basic è®¤è¯çš„ API
- âœ… è¯»å–å¯†é›†å‹æ“ä½œï¼ˆGET è¯·æ±‚ï¼‰
- âœ… å…·æœ‰æœ¬åœ° `$ref` å¼•ç”¨çš„è‰¯å¥½ç»“æ„è§„èŒƒ
- âœ… è·¯å¾„å’ŒæŸ¥è¯¢å‚æ•°ï¼ˆåŸºæœ¬ç±»å‹ï¼‰

**é‡è¦æç¤ºï¼š** å¯¹äºå…·æœ‰ç›¸å¯¹æœåŠ¡å™¨ URLï¼ˆå¦‚ `/api/v3`ï¼‰çš„è§„èŒƒï¼Œå¿…é¡»é€šè¿‡ `spec_url`ï¼ˆè€Œé `spec_inline`ï¼‰æä¾›è§„èŒƒï¼Œä»¥ä¾¿ Shannon å¯ä»¥è§£æå®Œæ•´çš„åŸºç¡€ URLã€‚ç¤ºä¾‹ï¼šPetStore è§„èŒƒå…·æœ‰ `servers: [{url: "/api/v3"}]`ï¼Œå½“ä» `https://petstore3.swagger.io/api/v3/openapi.json` åŠ è½½æ—¶è§£æä¸º `https://petstore3.swagger.io/api/v3`ã€‚

### æ­¥éª¤ 1: æ·»åŠ å·¥å…·å®šä¹‰

ç¼–è¾‘ `config/shannon.yaml` ä¸­çš„ `openapi_tools`ï¼š

```yaml
openapi_tools:
  petstore:
    enabled: true
    spec_url: "https://petstore3.swagger.io/api/v3/openapi.json"
    # æˆ–ä½¿ç”¨å†…è”è§„èŒƒï¼š
    # spec_inline: |
    #   <ç²˜è´´ OpenAPI JSON/YAML åœ¨è¿™é‡Œ>

    auth_type: "api_key"  # none|api_key|bearer|basic
    auth_config:
      api_key_name: "X-API-Key"           # Header åç§°æˆ–æŸ¥è¯¢å‚æ•°åç§°
      api_key_location: "header"          # header|query
      api_key_value: "$PETSTORE_API_KEY"  # ä½¿ç”¨ $ å‰ç¼€å¼•ç”¨ç¯å¢ƒå˜é‡

    category: "data"
    base_cost_per_use: 0.001
    rate_limit: 30                        # æ¯åˆ†é’Ÿè¯·æ±‚æ•°
    timeout_seconds: 30                   # è¯·æ±‚è¶…æ—¶
    max_response_bytes: 10485760          # æœ€å¤§å“åº”å¤§å°ï¼ˆ10MBï¼‰

    # å¯é€‰ï¼šè¿‡æ»¤ç‰¹å®šæ“ä½œ
    operations:
      - "getPetById"
      - "findPetsByStatus"

    # å¯é€‰ï¼šæŒ‰æ ‡ç­¾è¿‡æ»¤
    # tags:
    #   - "pet"

    # å¯é€‰ï¼šè¦†ç›–è§„èŒƒä¸­çš„åŸºç¡€ URL
    # base_url: "https://custom-petstore.example.com"
```

### è®¤è¯ç¤ºä¾‹

**Bearer ä»¤ç‰Œï¼ˆGitHub APIï¼‰ï¼š**
```yaml
github:
  enabled: true
  spec_url: "https://raw.githubusercontent.com/github/rest-api-description/main/descriptions/api.github.com/api.github.com.json"
  auth_type: "bearer"
  auth_config:
    token: "$GITHUB_TOKEN"
  operations:
    - "repos/get"
    - "repos/list-for-user"
```

**æŸ¥è¯¢ä¸­çš„ API Keyï¼ˆOpenWeatherï¼‰ï¼š**
```yaml
weather:
  enabled: true
  spec_url: "https://api.openweathermap.org/data/3.0/openapi.json"
  auth_type: "api_key"
  auth_config:
    api_key_name: "appid"
    api_key_location: "query"
    api_key_value: "$OPENWEATHER_API_KEY"
```

**Basic è®¤è¯ï¼š**
```yaml
custom_api:
  enabled: true
  spec_url: "https://api.example.com/openapi.json"
  auth_type: "basic"
  auth_config:
    username: "$API_USERNAME"
    password: "$API_PASSWORD"
```

### æ­¥éª¤ 2: é…ç½®ç¯å¢ƒ

æ·»åŠ åˆ° `.env`ï¼š

```bash
# OpenAPI å®‰å…¨
OPENAPI_ALLOWED_DOMAINS=*                # å¼€å‘ç”¨ *ï¼Œç”Ÿäº§ç”¨å…·ä½“åŸŸå
OPENAPI_MAX_SPEC_SIZE=5242880            # é»˜è®¤ 5MB
OPENAPI_FETCH_TIMEOUT=30                 # ç§’

# API å¯†é’¥
PETSTORE_API_KEY=your_key_here
GITHUB_TOKEN=ghp_xxxxxxxxxxxxx
OPENWEATHER_API_KEY=your_key
API_USERNAME=username
API_PASSWORD=password

# ä¸ MCP ç›¸åŒçš„æ³¨å†Œä»¤ç‰Œ
MCP_REGISTER_TOKEN=your_admin_token
```

### æ­¥éª¤ 3: é‡å¯æœåŠ¡

```bash
docker compose -f deploy/compose/docker-compose.yml up -d --force-recreate llm-service
```

### æ­¥éª¤ 4: éªŒè¯å’Œæµ‹è¯•

**é¦–å…ˆéªŒè¯è§„èŒƒï¼š**
```bash
curl -X POST http://localhost:8000/tools/openapi/validate \
  -H "Content-Type: application/json" \
  -d '{"spec_url": "https://petstore3.swagger.io/api/v3/openapi.json"}' | jq .
```

**å“åº”ï¼š**
```json
{
  "valid": true,
  "operations_count": 19,
  "operations": [
    {"operation_id": "getPetById", "method": "GET", "path": "/pet/{petId}"},
    {"operation_id": "addPet", "method": "POST", "path": "/pet"}
  ],
  "base_url": "https://petstore3.swagger.io/api/v3"
}
```

**åˆ—å‡ºå·²æ³¨å†Œå·¥å…·ï¼š**
```bash
curl http://localhost:8000/tools/list | grep Pet
```

**æ‰§è¡Œå·¥å…·ï¼š**
```bash
curl -X POST http://localhost:8000/tools/execute \
  -H "Content-Type: application/json" \
  -d '{
    "tool_name": "getPetById",
    "parameters": {"petId": 1}
  }' | jq .
```

### å¤‡é€‰æ–¹æ¡ˆï¼šè¿è¡Œæ—¶æ³¨å†Œ

```bash
curl -X POST http://localhost:8000/tools/openapi/register \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your_admin_token" \
  -d '{
    "name": "petstore",
    "spec_url": "https://petstore3.swagger.io/api/v3/openapi.json",
    "auth_type": "none",
    "category": "data",
    "operations": ["getPetById", "findPetsByStatus"],
    "rate_limit": 15,
    "timeout_seconds": 10
  }' | jq .
```

**å“åº”åŒ…å«éªŒè¯ï¼š**
```json
{
  "success": true,
  "collection_name": "petstore",
  "operations_registered": ["getPetById", "findPetsByStatus"],
  "rate_limit": 15,
  "timeout_seconds": 10,
  "max_response_bytes": 10485760
}
```

---

## æ·»åŠ å†…ç½® Python å·¥å…·

ç”¨äºå¤æ‚é€»è¾‘ã€æ•°æ®åº“è®¿é—®æˆ–æ€§èƒ½å…³é”®æ“ä½œã€‚

### ä½•æ—¶ä½¿ç”¨å†…ç½®å·¥å…·

**ä½¿ç”¨å†…ç½®å·¥å…·çš„åœºæ™¯ï¼š**
- éœ€è¦ç›´æ¥æ•°æ®åº“/Redis è®¿é—®
- éœ€è¦å¤æ‚çš„ Python åº“ï¼ˆpandasã€numpyï¼‰
- æ€§èƒ½å…³é”®ï¼ˆé¿å… HTTP å¾€è¿”ï¼‰
- éœ€è¦ä¼šè¯çŠ¶æ€ç®¡ç†
- å®ç°å®‰å…¨æ•æ„Ÿæ“ä½œ

**æ”¹ç”¨ MCP/OpenAPI çš„åœºæ™¯ï¼š**
- é›†æˆå¤–éƒ¨ API
- æ— ä»£ç éƒ¨ç½²
- å¿«é€ŸåŸå‹å¼€å‘
- ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ

### æ­¥éª¤ 1: åˆ›å»ºå·¥å…·ç±»

åœ¨ `python/llm-service/llm_service/tools/builtin/my_custom_tool.py` åˆ›å»ºæ–‡ä»¶ï¼š

```python
from typing import Any, Dict, List, Optional
from ..base import Tool, ToolMetadata, ToolParameter, ToolParameterType, ToolResult

class MyCustomTool(Tool):
    """
    å·¥å…·åŠŸèƒ½ç®€è¦æè¿°ã€‚
    """

    def _get_metadata(self) -> ToolMetadata:
        """å®šä¹‰å·¥å…·å…ƒæ•°æ®ã€‚"""
        return ToolMetadata(
            name="my_custom_tool",
            version="1.0.0",
            description="æ¸…æ™°æè¿°ä»¥ä¾¿ LLM ç†è§£ä½•æ—¶/å¦‚ä½•ä½¿ç”¨æ­¤å·¥å…·",
            category="custom",  # search, data, analytics, code, file, custom
            author="ä½ çš„åå­—",
            requires_auth=False,
            timeout_seconds=30,
            memory_limit_mb=128,
            sandboxed=False,
            session_aware=False,  # å¦‚æœå·¥å…·éœ€è¦ä¼šè¯çŠ¶æ€åˆ™è®¾ä¸º True
            dangerous=False,      # æ–‡ä»¶å†™å…¥ã€ä»£ç æ‰§è¡Œè®¾ä¸º True
            cost_per_use=0.001,   # æ¯æ¬¡è°ƒç”¨çš„ç¾å…ƒæˆæœ¬
            rate_limit=60,        # æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼ˆç”±åŸºç±»å¼ºåˆ¶æ‰§è¡Œï¼‰
        )

    def _get_parameters(self) -> List[ToolParameter]:
        """å®šä¹‰å¸¦éªŒè¯çš„å·¥å…·å‚æ•°ã€‚"""
        return [
            ToolParameter(
                name="required_param",
                type=ToolParameterType.STRING,
                description="å‘ LLM å±•ç¤ºçš„æè¿°",
                required=True,
            ),
            ToolParameter(
                name="optional_number",
                type=ToolParameterType.INTEGER,
                description="å¯é€‰çš„æ•°å­—å‚æ•°",
                required=False,
                default=10,
                min_value=1,
                max_value=100,
            ),
            ToolParameter(
                name="choice_param",
                type=ToolParameterType.STRING,
                description="å…·æœ‰é¢„å®šä¹‰é€‰é¡¹çš„å‚æ•°",
                required=False,
                enum=["option1", "option2", "option3"],
            ),
        ]

    async def _execute_impl(
        self,
        session_context: Optional[Dict] = None,
        **kwargs
    ) -> ToolResult:
        """
        æ‰§è¡Œå·¥å…·é€»è¾‘ã€‚

        å‚æ•°:
            session_context: å¦‚æœ session_aware=True åˆ™ä¸ºä¼šè¯æ•°æ®
            **kwargs: å·¥å…·å‚æ•°ï¼ˆè‡ªåŠ¨éªŒè¯ï¼‰

        è¿”å›:
            å¸¦æˆåŠŸ/é”™è¯¯çŠ¶æ€çš„ ToolResult
        """
        try:
            # æå–å‚æ•°ï¼ˆå·²ç”±åŸºç±»éªŒè¯ï¼‰
            required_param = kwargs.get("required_param")
            optional_number = kwargs.get("optional_number", 10)
            choice_param = kwargs.get("choice_param")

            # ä½ çš„å·¥å…·é€»è¾‘åœ¨è¿™é‡Œ
            result = self._do_work(required_param, optional_number, choice_param)

            return ToolResult(
                success=True,
                output=result,
                metadata={"processed": True},
                execution_time_ms=50,
            )

        except Exception as e:
            return ToolResult(
                success=False,
                output=None,
                error=f"å·¥å…·æ‰§è¡Œå¤±è´¥: {str(e)}"
            )

    def _do_work(self, param1, param2, param3):
        """ä½ çš„å®é™…å®ç°ã€‚"""
        # ç¤ºä¾‹ï¼šæ•°æ®åº“æŸ¥è¯¢ã€API è°ƒç”¨ã€è®¡ç®—
        return {"result": "success", "data": [1, 2, 3]}
```

### æ­¥éª¤ 2: æ³¨å†Œå·¥å…·

ç¼–è¾‘ `python/llm-service/llm_service/api/tools.py` ç¬¬ 228 è¡Œé™„è¿‘ï¼š

```python
# åœ¨é¡¶éƒ¨æ·»åŠ å¯¼å…¥
from ..tools.builtin.my_custom_tool import MyCustomTool

# åœ¨ startup_event() ä¸­æ·»åŠ åˆ°æ³¨å†Œåˆ—è¡¨
@router.on_event("startup")
async def startup_event():
    registry = get_registry()

    tools_to_register = [
        WebSearchTool,
        CalculatorTool,
        FileReadTool,
        FileWriteTool,
        PythonWasiExecutorTool,
        MyCustomTool,  # åœ¨è¿™é‡Œæ·»åŠ ä½ çš„å·¥å…·
    ]

    for tool_class in tools_to_register:
        try:
            registry.register(tool_class)
            logger.info(f"Registered tool: {tool_class.__name__}")
        except Exception as e:
            logger.error(f"Failed to register {tool_class.__name__}: {e}")
```

### æ­¥éª¤ 3: é‡å¯æœåŠ¡

```bash
docker compose -f deploy/compose/docker-compose.yml up -d --force-recreate llm-service
```

### æ­¥éª¤ 4: æµ‹è¯•å·¥å…·

```bash
# éªŒè¯æ³¨å†Œ
curl http://localhost:8000/tools/list | grep my_custom_tool

# è·å–æ¨¡å¼
curl http://localhost:8000/tools/my_custom_tool/schema | jq .

# æ‰§è¡Œ
curl -X POST http://localhost:8000/tools/execute \
  -H "Content-Type: application/json" \
  -d '{
    "tool_name": "my_custom_tool",
    "parameters": {
      "required_param": "test",
      "optional_number": 42,
      "choice_param": "option1"
    }
  }' | jq .
```

### é«˜çº§ï¼šä¼šè¯æ„ŸçŸ¥å·¥å…·

ç”¨äºè·¨æ‰§è¡Œç»´æŠ¤çŠ¶æ€çš„å·¥å…·ï¼š

```python
class SessionAwareTool(Tool):
    def _get_metadata(self) -> ToolMetadata:
        return ToolMetadata(
            name="session_tool",
            session_aware=True,  # å¯ç”¨ä¼šè¯ä¸Šä¸‹æ–‡
            ...
        )

    async def _execute_impl(
        self,
        session_context: Optional[Dict] = None,
        **kwargs
    ) -> ToolResult:
        # è®¿é—®ä¼šè¯æ•°æ®
        session_id = session_context.get("session_id") if session_context else None
        user_id = session_context.get("user_id") if session_context else None

        # å­˜å‚¨/æ£€ç´¢ä¼šè¯ç‰¹å®šæ•°æ®
        # ç¤ºä¾‹ï¼šRedisã€æ•°æ®åº“ã€å†…å­˜ç¼“å­˜

        return ToolResult(success=True, output={"session": session_id})
```

---

## é…ç½®å‚è€ƒ

### MCP å·¥å…·é…ç½®

```yaml
mcp_tools:
  tool_name:
    enabled: true                    # å¿…å¡«ï¼šå¯ç”¨/ç¦ç”¨å·¥å…·
    url: "https://api.example.com"   # å¿…å¡«ï¼šHTTP ç«¯ç‚¹
    func_name: "function_name"       # å¿…å¡«ï¼šè¿œç¨‹å‡½æ•°å
    description: "å·¥å…·æè¿°"          # å¿…å¡«ï¼šLLM å¯è§æè¿°
    category: "data"                 # å¿…å¡«ï¼šå·¥å…·ç±»åˆ«
    cost_per_use: 0.001             # å¿…å¡«ï¼šç¾å…ƒæˆæœ¬
    parameters:                      # å¿…å¡«ï¼šå‚æ•°å®šä¹‰
      - name: "param1"
        type: "string"               # string|integer|float|boolean|array|object
        required: true
        description: "å‚æ•°æè¿°"
        enum: ["val1", "val2"]       # å¯é€‰ï¼šå…è®¸çš„å€¼
        default: "val1"              # å¯é€‰ï¼šé»˜è®¤å€¼
    headers:                         # å¯é€‰ï¼šHTTP å¤´
      X-API-Key: "${API_KEY_VAR}"   # ä½¿ç”¨ ${} å¼•ç”¨ç¯å¢ƒå˜é‡
```

### OpenAPI å·¥å…·é…ç½®

```yaml
openapi_tools:
  collection_name:
    enabled: true
    spec_url: "https://api.example.com/openapi.json"  # æˆ– spec_inline
    auth_type: "none"                # none|api_key|bearer|basic
    auth_config:                     # auth_type != "none" æ—¶å¿…å¡«
      # å¯¹äº api_key:
      api_key_name: "X-API-Key"
      api_key_location: "header"     # header|query
      api_key_value: "$API_KEY"
      # å¯¹äº bearer:
      token: "$BEARER_TOKEN"
      # å¯¹äº basic:
      username: "$USERNAME"
      password: "$PASSWORD"
    category: "api"
    base_cost_per_use: 0.001
    rate_limit: 30                   # æ¯åˆ†é’Ÿè¯·æ±‚æ•°
    timeout_seconds: 30              # è¯·æ±‚è¶…æ—¶
    max_response_bytes: 10485760     # æœ€å¤§å“åº”å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    operations:                      # å¯é€‰ï¼šè¿‡æ»¤æ“ä½œ
      - "operationId1"
      - "operationId2"
    tags:                            # å¯é€‰ï¼šæŒ‰æ ‡ç­¾è¿‡æ»¤
      - "tag1"
    base_url: "https://override.com" # å¯é€‰ï¼šè¦†ç›–è§„èŒƒåŸºç¡€ URL
```

### ç¯å¢ƒå˜é‡

**MCP é…ç½®ï¼š**
```bash
# åŸŸåå®‰å…¨
MCP_ALLOWED_DOMAINS=localhost,127.0.0.1,api.example.com  # æˆ–å¼€å‘ç”¨ *

# ç†”æ–­å™¨
MCP_CB_FAILURES=5                    # ç†”æ–­å‰çš„å¤±è´¥æ¬¡æ•°
MCP_CB_RECOVERY_SECONDS=60           # ç†”æ–­å¼€å¯æŒç»­æ—¶é—´

# è¯·æ±‚é™åˆ¶
MCP_MAX_RESPONSE_BYTES=10485760      # é»˜è®¤ 10MB
MCP_RETRIES=3                        # é‡è¯•æ¬¡æ•°
MCP_TIMEOUT_SECONDS=10               # è¯·æ±‚è¶…æ—¶

# æ³¨å†Œå®‰å…¨
MCP_REGISTER_TOKEN=your_secret       # API æ³¨å†Œä¿æŠ¤
```

**OpenAPI é…ç½®ï¼š**
```bash
# åŸŸåå®‰å…¨
OPENAPI_ALLOWED_DOMAINS=*            # é€—å·åˆ†éš”æˆ–å¼€å‘ç”¨ *
OPENAPI_MAX_SPEC_SIZE=5242880        # 5MB è§„èŒƒå¤§å°é™åˆ¶
OPENAPI_FETCH_TIMEOUT=30             # è§„èŒƒè·å–è¶…æ—¶

# è¯·æ±‚è¡Œä¸º
OPENAPI_RETRIES=3                    # é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ï¼š3ï¼ŒåŒ¹é… MCPï¼‰
```

**å·¥å…·ç‰¹å®š API å¯†é’¥ï¼š**
```bash
# åœ¨è¿™é‡Œæ·»åŠ ä½ çš„å·¥å…· API å¯†é’¥
WEATHER_API_KEY=your_key
STOCK_API_KEY=your_key
GITHUB_TOKEN=ghp_xxxxx
PETSTORE_API_KEY=your_key
# ... æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤š
```

---

## æµ‹è¯•ä¸éªŒè¯

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥æœåŠ¡å¥åº·
curl http://localhost:8081/health | jq .

# æ£€æŸ¥ LLM æœåŠ¡çŠ¶æ€
docker inspect shannon-llm-service-1 --format='{{.State.Health.Status}}'
```

### åˆ—å‡ºå·¥å…·

```bash
# æ‰€æœ‰å·¥å…·
curl http://localhost:8000/tools/list | jq .

# æŒ‰ç±»åˆ«
curl "http://localhost:8000/tools/list?category=data" | jq .

# æ’é™¤å±é™©å·¥å…·
curl "http://localhost:8000/tools/list?exclude_dangerous=true" | jq .

# åˆ—å‡ºç±»åˆ«
curl http://localhost:8000/tools/categories | jq .
```

### è·å–å·¥å…·æ¨¡å¼

```bash
# å•ä¸ªå·¥å…·æ¨¡å¼
curl http://localhost:8000/tools/my_tool/schema | jq .

# æ‰€æœ‰æ¨¡å¼
curl http://localhost:8000/tools/schemas | jq .

# å·¥å…·å…ƒæ•°æ®
curl http://localhost:8000/tools/my_tool/metadata | jq .
```

### æ‰§è¡Œå·¥å…·

**ç›´æ¥æ‰§è¡Œï¼š**
```bash
curl -X POST http://localhost:8000/tools/execute \
  -H "Content-Type: application/json" \
  -d '{
    "tool_name": "calculator",
    "parameters": {"expression": "sqrt(144) + 2^3"}
  }' | jq .
```

**æ‰¹é‡æ‰§è¡Œï¼š**
```bash
curl -X POST http://localhost:8000/tools/batch-execute \
  -H "Content-Type: application/json" \
  -d '[
    {"tool_name": "calculator", "parameters": {"expression": "2+2"}},
    {"tool_name": "calculator", "parameters": {"expression": "10*5"}}
  ]' | jq .
```

**é€šè¿‡å·¥ä½œæµï¼š**
```bash
SESSION_ID="test-$(date +%s)" ./scripts/submit_task.sh "è®¡ç®— 2+2 ç„¶åä¹˜ä»¥ 5"
```

### ç›‘æ§æ—¥å¿—

```bash
# æ³¨å†Œæ—¥å¿—
docker compose logs llm-service | grep -i "registered tool"
docker compose logs llm-service | grep -i "loaded.*tools"

# æ‰§è¡Œæ—¥å¿—
docker compose logs -f llm-service orchestrator agent-core

# å·¥å…·ç‰¹å®šæ—¥å¿—
docker compose logs llm-service | grep "my_tool"
```

### ç«¯åˆ°ç«¯æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
make smoke

# è¿è¡Œå·¥å…·ç‰¹å®šæµ‹è¯•
./tests/e2e/01_basic_calculator_test.sh
./tests/e2e/06_openapi_petstore_test.sh

# ä½¿ç”¨ MCP å·¥å…·è¿è¡Œ
./tests/e2e/run.sh
```

---

## æ•…éšœæ’é™¤

### å·¥å…·æœªæ³¨å†Œ

**ç—‡çŠ¶ï¼š** å·¥å…·æœªå‡ºç°åœ¨ `/tools/list`

**è°ƒè¯•æ­¥éª¤ï¼š**
```bash
# 1. æ£€æŸ¥ YAML è¯­æ³•
yamllint config/shannon.yaml

# 2. æ£€æŸ¥æ—¥å¿—ä¸­çš„é”™è¯¯
docker compose logs llm-service | grep -i error

# 3. éªŒè¯å¯ç”¨æ ‡å¿—
grep -A 10 "my_tool" config/shannon.yaml | grep enabled

# 4. å¼ºåˆ¶é‡æ–°åˆ›å»ºæœåŠ¡
docker compose -f deploy/compose/docker-compose.yml up -d --force-recreate llm-service

# 5. ç­‰å¾…å¥åº·æ£€æŸ¥
sleep 10
docker inspect shannon-llm-service-1 --format='{{.State.Health.Status}}'
```

### åŸŸåéªŒè¯é”™è¯¯

**ç—‡çŠ¶ï¼š** `URL host 'example.com' not in allowed domains`

**è§£å†³æ–¹æ¡ˆï¼š**

1. **å¼€å‘ç¯å¢ƒï¼š** ä½¿ç”¨é€šé…ç¬¦
   ```bash
   # .env
   MCP_ALLOWED_DOMAINS=*
   OPENAPI_ALLOWED_DOMAINS=*
   ```

2. **ç”Ÿäº§ç¯å¢ƒï¼š** æ·»åŠ ç‰¹å®šåŸŸå
   ```bash
   # .env
   MCP_ALLOWED_DOMAINS=localhost,127.0.0.1,api.example.com
   OPENAPI_ALLOWED_DOMAINS=api.example.com,api.github.com
   ```

3. **Docker Composeï¼š** åœ¨ç¯å¢ƒä¸­è®¾ç½®
   ```yaml
   services:
     llm-service:
       environment:
         - MCP_ALLOWED_DOMAINS=api.example.com
   ```

### å·¥å…·æ‰§è¡Œå¤±è´¥

**ç—‡çŠ¶ï¼š** `ToolResult { success: false, error: "..." }`

**è°ƒè¯•ï¼š**
```bash
# 1. ç›´æ¥æµ‹è¯•å·¥å…·
curl -X POST http://localhost:8000/tools/execute \
  -H "Content-Type: application/json" \
  -d '{"tool_name":"my_tool","parameters":{...}}' | jq .

# 2. æ£€æŸ¥å‚æ•°ç±»å‹
curl http://localhost:8000/tools/my_tool/schema | jq '.parameters'

# 3. éªŒè¯å‚æ•°åŒ¹é…æ¨¡å¼
# å¿…é¡»æä¾›å¿…å¡«å‚æ•°
# ç±»å‹å¿…é¡»åŒ¹é…ï¼ˆstring vs integerï¼‰
# æšä¸¾å€¼å¿…é¡»åœ¨å…è®¸åˆ—è¡¨ä¸­

# 4. æ£€æŸ¥ agent core æ—¥å¿—
docker logs shannon-agent-core-1 | grep "Tool execution error"

# 5. æ£€æŸ¥ LLM æœåŠ¡æ—¥å¿—
docker logs shannon-llm-service-1 | grep my_tool
```

### LLM æœªé€‰æ‹©å·¥å…·

**ç—‡çŠ¶ï¼š** LLM ä¸ä½¿ç”¨ä½ çš„å·¥å…·å¤„ç†ç›¸å…³æŸ¥è¯¢

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ”¹è¿›æè¿°ï¼š** ä½¿å…¶å…·ä½“å¹¶ä½¿ç”¨ LLM å‹å¥½çš„å…³é”®è¯
   ```yaml
   # ä¸å¥½
   description: "å¤©æ°”å·¥å…·"

   # å¥½
   description: "è·å–ä»»ä½•åŸå¸‚çš„å®æ—¶å¤©æ°”é¢„æŠ¥æ•°æ®ï¼ŒåŒ…æ‹¬æ¸©åº¦ã€æ¹¿åº¦å’ŒçŠ¶å†µã€‚ç”¨äºæœ‰å…³å½“å‰æˆ–æœªæ¥å¤©æ°”çš„æŸ¥è¯¢ã€‚"
   ```

2. **æ·»åŠ åˆ°åˆ†è§£ä¸Šä¸‹æ–‡ï¼š**

   å½“å‰é™åˆ¶ï¼šç¼–æ’å™¨å‘åˆ†è§£ä¼ é€’ç©ºå·¥å…·åˆ—è¡¨ã€‚é»˜è®¤æƒ…å†µä¸‹å·¥å…·ä¸ä¼šå‡ºç°åœ¨ç³»ç»Ÿæç¤ºä¸­ã€‚

   **å¿«é€Ÿä¿®å¤ï¼š** Agent æœåŠ¡æœ‰è‡ªåŠ¨åŠ è½½å›é€€ï¼ˆ`agent.py` ç¬¬ 598-609 è¡Œï¼‰

   **æ­£ç¡®ä¿®å¤ï¼š** æ›´æ–°ç¼–æ’å™¨å·¥ä½œæµä»¥è°ƒç”¨ `fetchAvailableTools()` å¹¶åœ¨ `AvailableTools` å­—æ®µä¸­ä¼ é€’ï¼š
   - `go/orchestrator/internal/workflows/orchestrator_router.go:80`
   - `go/orchestrator/internal/workflows/supervisor_workflow.go:273`

3. **æµ‹è¯•å·¥å…·é€‰æ‹©ï¼š**
   ```bash
   curl -X POST http://localhost:8000/tools/select \
     -H "Content-Type: application/json" \
     -d '{
       "task": "è·å–ä¸œäº¬çš„å¤©æ°”é¢„æŠ¥",
       "max_tools": 3
     }' | jq .
   ```

4. **ä½¿ç”¨æ˜ç¡®æåŠï¼š**
   ```bash
   ./scripts/submit_task.sh "ä½¿ç”¨ weather_forecast å·¥å…·è·å–ä¸œäº¬çš„å¤©æ°”"
   ```

### ç†”æ–­å™¨è§¦å‘

**ç—‡çŠ¶ï¼š** `Circuit breaker open for <url> (too many failures)`

**è°ƒè¯•ï¼š**
```bash
# æ£€æŸ¥æœ€è¿‘é”™è¯¯
docker logs shannon-llm-service-1 --tail 100 | grep -i "circuit\|failure"

# ç­‰å¾…æ¢å¤ï¼ˆé»˜è®¤ 60 ç§’ï¼‰
sleep 60

# æˆ–é‡å¯ä»¥é‡ç½®
docker compose restart llm-service
```

**é¢„é˜²ï¼š**
- å¢åŠ å¤±è´¥é˜ˆå€¼ï¼š`MCP_CB_FAILURES=10`
- å¢åŠ æ¢å¤æ—¶é—´ï¼š`MCP_CB_RECOVERY_SECONDS=120`
- ä¿®å¤åº•å±‚ API é—®é¢˜

### é€Ÿç‡é™åˆ¶è¶…å‡º

**ç—‡çŠ¶ï¼š** `Rate limit exceeded for tool <name>`

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# åœ¨é…ç½®ä¸­å¢åŠ é€Ÿç‡é™åˆ¶
# config/shannon.yaml
rate_limit: 120  # ä»é»˜è®¤ 60 å¢åŠ 

# æˆ–åœ¨å·¥å…·å…ƒæ•°æ®ä¸­ï¼ˆå†…ç½®å·¥å…·ï¼‰
ToolMetadata(
    rate_limit=120,  # æ¯åˆ†é’Ÿè¯·æ±‚æ•°
    ...
)
```

---

## å®‰å…¨æœ€ä½³å®è·µ

### åŸŸåç™½åå•

**å¼€å‘ç¯å¢ƒï¼š**
```bash
# å®½æ¾çš„æµ‹è¯•ç¯å¢ƒ
MCP_ALLOWED_DOMAINS=*
OPENAPI_ALLOWED_DOMAINS=*
```

**é¢„å‘å¸ƒç¯å¢ƒï¼š**
```bash
# ç‰¹å®šåŸŸå + localhost
MCP_ALLOWED_DOMAINS=localhost,127.0.0.1,staging-api.example.com
```

**ç”Ÿäº§ç¯å¢ƒï¼š**
```bash
# ä»…æ˜¾å¼ç™½åå•
MCP_ALLOWED_DOMAINS=api.example.com,api.partner.com
OPENAPI_ALLOWED_DOMAINS=api.github.com,api.openweathermap.org
```

**å­åŸŸååŒ¹é…ï¼š**
- `api.example.com` å…è®¸ `api.example.com` å’Œ `v1.api.example.com`
- é€šé…ç¬¦ `*` ç»•è¿‡æ‰€æœ‰éªŒè¯ï¼ˆè°¨æ…ä½¿ç”¨ï¼ï¼‰

### API å¯†é’¥ç®¡ç†

**âŒ æ°¸è¿œä¸è¦ç¡¬ç¼–ç ï¼š**
```yaml
# ä¸å¥½ - ä¸è¦è¿™æ ·åšï¼
headers:
  X-API-Key: "sk-1234567890abcdef"
```

**âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼š**
```yaml
# å¥½ - å¼•ç”¨ç¯å¢ƒå˜é‡
headers:
  X-API-Key: "${WEATHER_API_KEY}"
```

**å­˜å‚¨åœ¨ `.env`ï¼ˆä¸è¢« git è·Ÿè¸ªï¼‰ï¼š**
```bash
# .env
WEATHER_API_KEY=sk-real-key-here
STOCK_API_KEY=your-stock-key
```

**ç”Ÿäº§ç¯å¢ƒï¼š** ä½¿ç”¨å¯†é’¥ç®¡ç†
- Docker secrets
- Kubernetes secrets
- HashiCorp Vault
- AWS Secrets Manager

### é€Ÿç‡é™åˆ¶

**æ¯ä¸ªå·¥å…·é™åˆ¶ï¼š**
```yaml
# MCP å·¥å…·
mcp_tools:
  expensive_api:
    rate_limit: 10  # æ˜‚è´µè°ƒç”¨çš„ä½é™åˆ¶

# OpenAPI å·¥å…·
openapi_tools:
  github:
    rate_limit: 60  # GitHub çš„å®é™…é™åˆ¶
```

**å…¨å±€é™åˆ¶ï¼š**
```bash
# .env
MCP_RATE_LIMIT_DEFAULT=60    # æ‰€æœ‰ MCP å·¥å…·çš„é»˜è®¤å€¼
```

### ç†”æ–­å™¨

**é…ç½®ï¼š**
```bash
# MCP ç†”æ–­å™¨
MCP_CB_FAILURES=5                 # 5 æ¬¡å¤±è´¥åå¼€å¯
MCP_CB_RECOVERY_SECONDS=60        # ä¿æŒå¼€å¯ 60 ç§’

# å†…ç½®çš„æ¯ä¸ª base_url ç†”æ–­å™¨
# - é˜²æ­¢çº§è”æ•…éšœ
# - éš”ç¦»è¡Œä¸ºä¸å½“çš„æœåŠ¡
# - è¶…æ—¶åè‡ªåŠ¨æ¢å¤
```

### è®¤è¯

**MCP æ³¨å†Œ APIï¼š**
```bash
# åŠ¨æ€æ³¨å†Œéœ€è¦ä»¤ç‰Œ
MCP_REGISTER_TOKEN=your-secure-random-token

# åœ¨è¯·æ±‚ä¸­ä½¿ç”¨
curl -H "Authorization: Bearer your-secure-random-token" ...
# æˆ–
curl -H "X-Admin-Token: your-secure-random-token" ...
```

**ç”Ÿæˆå®‰å…¨ä»¤ç‰Œï¼š**
```bash
openssl rand -hex 32
```

### å±é™©å·¥å…·

æ ‡è®°ä¿®æ”¹çŠ¶æ€æˆ–è®¿é—®æ•æ„Ÿèµ„æºçš„å·¥å…·ï¼š

```python
ToolMetadata(
    name="file_write",
    dangerous=True,        # è§¦å‘ OPA ç­–ç•¥æ£€æŸ¥
    requires_auth=True,    # éœ€è¦ç”¨æˆ·èº«ä»½éªŒè¯
    ...
)
```

**OPA ç­–ç•¥å¯ä»¥è¿›è¡Œè®¿é—®æ§åˆ¶ï¼š**
```rego
# config/opa/policies/tools.rego
package tools

deny[msg] {
    input.tool == "file_write"
    not is_admin(input.user)
    msg := "file_write éœ€è¦ç®¡ç†å‘˜è§’è‰²"
}
```

### å“åº”å¤§å°é™åˆ¶

**é˜²æ­¢å¤§å“åº” DoSï¼š**
```yaml
# OpenAPI å·¥å…·
max_response_bytes: 10485760  # é»˜è®¤ 10MB

# MCP å·¥å…·ï¼ˆç¯å¢ƒå˜é‡ï¼‰
MCP_MAX_RESPONSE_BYTES=10485760
```

### è¶…æ—¶é…ç½®

**é˜²æ­¢æŒ‚èµ·è¯·æ±‚ï¼š**
```yaml
# OpenAPI å·¥å…·
timeout_seconds: 30  # æ¯ä¸ªè¯·æ±‚è¶…æ—¶

# MCP å·¥å…·ï¼ˆç¯å¢ƒå˜é‡ï¼‰
MCP_TIMEOUT_SECONDS=10
```

### HTTPS å¼ºåˆ¶

**å¯¹äºé localhost URLï¼ŒShannon å¼ºåˆ¶ HTTPSï¼š**
- âœ… `https://api.example.com` - å…è®¸
- âœ… `http://localhost:8080` - å…è®¸
- âŒ `http://api.example.com` - ç”Ÿäº§ç¯å¢ƒæ‹’ç»

---

## ä¸‹ä¸€æ­¥

**æ¢ç´¢é«˜çº§ä¸»é¢˜ï¼š**
- [å·¥å…·å®ç°æŒ‡å—](tools-implementation-guide.md) - æ¶æ„æ·±å…¥ (è‹±æ–‡)
- [MCP é›†æˆ](mcp-integration.md) - å®Œæ•´ MCP è§„èŒƒ (è‹±æ–‡)
- [Python WASI æ‰§è¡Œ](python-code-execution.md) - æ²™ç®±ä»£ç æ‰§è¡Œ (è‹±æ–‡)

**ç¤ºä¾‹å·¥å…·ï¼š**
- å†…ç½®å·¥å…·ï¼š`python/llm-service/llm_service/tools/builtin/`
- MCP ç¤ºä¾‹ï¼š`config/shannon.yaml`ï¼ˆæ³¨é‡Šç¤ºä¾‹ï¼‰
- OpenAPI ç¤ºä¾‹ï¼š`tests/e2e/06_openapi_petstore_test.sh`

**ç¤¾åŒºï¼š**
- æŠ¥å‘Šé—®é¢˜ï¼šhttps://github.com/Kocoro-lab/Shannon/issues
- è´¡çŒ®å·¥å…·ï¼šhttps://github.com/Kocoro-lab/Shannon/pulls

---

## æ€»ç»“

**æ·»åŠ å·¥å…·çš„ä¸‰ç§æ–¹å¼ï¼š**

| æ–¹æ³• | å‘½ä»¤ | é…ç½®æ–‡ä»¶ | ä»£ç ä¿®æ”¹ |
|------|------|---------|---------|
| **MCP** | `docker compose up -d --force-recreate llm-service` | `config/shannon.yaml` | æ—  |
| **OpenAPI** | `docker compose up -d --force-recreate llm-service` | `config/shannon.yaml` | æ—  |
| **å†…ç½®** | `docker compose up -d --force-recreate llm-service` | `api/tools.py` + æ–°æ–‡ä»¶ | ä»… Python |

**å…³é”®è¦ç‚¹ï¼š**
- âœ… é›¶ proto/Rust/Go ä¿®æ”¹ï¼ˆé€šç”¨ `google.protobuf.Struct` å®¹å™¨ï¼‰
- âœ… å†…ç½®å®‰å…¨ï¼ˆåŸŸåç™½åå•ã€é€Ÿç‡é™åˆ¶ã€ç†”æ–­å™¨ï¼‰
- âœ… è‡ªåŠ¨æˆæœ¬è·Ÿè¸ªï¼ˆåœ¨å…ƒæ•°æ®ä¸­è®¾ç½® `cost_per_use`ï¼‰
- âœ… æ¨¡å¼é©±åŠ¨ï¼ˆOpenAI å…¼å®¹çš„ JSON æ¨¡å¼ï¼‰

**å¿«é€Ÿå‚è€ƒï¼š**
```bash
# åˆ—å‡ºå·¥å…·
curl http://localhost:8000/tools/list

# è·å–æ¨¡å¼
curl http://localhost:8000/tools/{name}/schema

# æ‰§è¡Œ
curl -X POST http://localhost:8000/tools/execute \
  -d '{"tool_name":"my_tool","parameters":{...}}'

# é€šè¿‡å·¥ä½œæµ
./scripts/submit_task.sh "ä½ çš„æŸ¥è¯¢åœ¨è¿™é‡Œ"
```

ç¥å·¥å…·æ„å»ºæ„‰å¿«ï¼ğŸ› ï¸

---

*æœ€åæ›´æ–°ï¼š2025 å¹´ 1 æœˆ*

