# .env Configuration Update Analysis

## Architecture Changes Summary

Shannon has undergone a major architectural shift:

### Old Architecture
- **Python LLM Service** (`python/llm-service/`) - Port 8000
- **Go Gateway** (`go/orchestrator/cmd/gateway/`) - Port 8080
- **Go Orchestrator** - Port 50052
- **Rust Agent Core** - Port 50051

### New Architecture
- **Rust Shannon API** (`rust/shannon-api/`) - Port 8080 (main) + 8081 (admin)
  - Combines Gateway + LLM Service functionality
  - Multi-provider LLM support built-in
  - JWT/API key authentication
  - Rate limiting and session management
- **Go Orchestrator** - Port 50052 (unchanged)
- **Rust Agent Core** - Port 50051 (unchanged)

### Legacy Services (Deprecated)
- `llm-service` - Only starts with `--profile legacy`
- `gateway` - Only starts with `--profile legacy`

## Current .env Issues

### 1. **Deprecated Service References**
```bash
# Line 14: References Python LLM service
SERVICE_NAME=shannon-llm-service

# Line 92: Python LLM service URL (still used by agent-core in docker-compose)
LLM_SERVICE_URL=http://llm-service:8000

# Line 173: OTEL service name for Python service
OTEL_SERVICE_NAME=shannon-llm-service
```

**Issue**: These reference the deprecated Python LLM service. However, `LLM_SERVICE_URL` is still used by `agent-core` in docker-compose.yml (line 115), so it needs to remain but should point to shannon-api.

### 2. **Missing Shannon API Configuration**
The new `shannon-api` service needs:
- `SHANNON_API_HOST` (default: 0.0.0.0)
- `SHANNON_API_PORT` (default: 8080)
- `SHANNON_API_ADMIN_PORT` (default: 8081)
- `RUST_LOG` (logging level)

These are defined in docker-compose.yml but not documented in .env.

### 3. **Desktop App Configuration Mismatch**

**desktop/.env.production**:
```bash
NEXT_PUBLIC_API_URL=http://localhost:8080  # Correct - points to shannon-api
```

**desktop/.env.local**:
```bash
NEXT_PUBLIC_API_URL=http://localhost:8080  # Correct - points to shannon-api
```

Both desktop configs correctly point to port 8080, which is now shannon-api (not the old gateway).

### 4. **Variables That Should Be Removed**
These are Python LLM service specific and no longer relevant:
- `SERVICE_NAME` (line 14) - Python service identifier
- `OTEL_SERVICE_NAME` (line 173) - Python service telemetry
- Most Python-specific LLM configuration (handled by shannon-api now)

### 5. **Variables That Need Updates**
- `LLM_SERVICE_URL` should point to shannon-api or be renamed
- Gateway-specific variables need clarification (some still used by orchestrator)

## Docker Compose Port Mapping

From `deploy/compose/docker-compose.yml`:

```yaml
shannon-api:
  ports:
    - "8080:8080"   # Main API (was gateway)
    - "8082:8081"   # Admin/metrics (offset to avoid orchestrator conflict)

orchestrator:
  ports:
    - "50052:50052" # gRPC
    - "2112:2112"   # Metrics
    - "8081:8081"   # Admin/events

agent-core:
  ports:
    - "50051:50051" # gRPC
    - "2113:2113"   # Metrics
  environment:
    - LLM_SERVICE_URL=${LLM_SERVICE_URL:-http://llm-service:8000}  # Still references old service!
```

**Critical Issue**: `agent-core` still expects `LLM_SERVICE_URL` to point to an LLM service. Since shannon-api now provides this, we need to either:
1. Update agent-core to call shannon-api directly
2. Keep the variable but point it to shannon-api
3. Verify if agent-core actually uses this variable

## Variables Analysis

### Keep (Core Infrastructure)
✅ All database variables (POSTGRES_*)
✅ All Redis variables (REDIS_*)
✅ All Qdrant variables (QDRANT_*)
✅ All LLM provider API keys (OPENAI_API_KEY, ANTHROPIC_API_KEY, etc.)
✅ Web search/fetch configuration
✅ Temporal configuration
✅ Orchestrator configuration
✅ Agent Core configuration
✅ Security/auth variables (JWT_SECRET, GATEWAY_SKIP_AUTH)

### Update/Clarify
⚠️ `SERVICE_NAME` → Should be removed or renamed to `SHANNON_API_SERVICE_NAME`
⚠️ `LLM_SERVICE_URL` → Should point to shannon-api or be removed if unused
⚠️ `OTEL_SERVICE_NAME` → Should be removed or updated for shannon-api
⚠️ `ADMIN_SERVER` → Still points to orchestrator:8081 (correct)

### Add (New Shannon API)
➕ `SHANNON_API_HOST` (optional, default 0.0.0.0)
➕ `SHANNON_API_PORT` (optional, default 8080)
➕ `SHANNON_API_ADMIN_PORT` (optional, default 8081)
➕ `RUST_LOG` (optional, for shannon-api logging)

### Remove (Deprecated Python LLM Service)
❌ Python-specific cache configuration (if any)
❌ Python-specific rate limiting (now handled by shannon-api)
❌ Python-specific tool configuration (now in shannon-api)

## Recommendations

### 1. Update .env Structure
Reorganize into clear sections:
- **Shannon API (Rust)** - New unified service
- **Orchestrator (Go)** - Workflow engine
- **Agent Core (Rust)** - WASI sandbox
- **Data Stores** - Postgres, Redis, Qdrant
- **LLM Providers** - API keys
- **Tools & Integrations** - Web search, MCP, etc.

### 2. Deprecation Notices
Add comments for deprecated variables that are kept for backward compatibility.

### 3. Desktop App Alignment
Ensure desktop .env files reference the correct ports:
- Main API: `http://localhost:8080` (shannon-api) ✅ Already correct
- Admin/Events: `http://localhost:8082` (shannon-api admin)
- Orchestrator Events: `http://localhost:8081` (orchestrator)

### 4. Migration Path
For users upgrading:
1. Keep legacy variables commented out with migration notes
2. Add clear section headers
3. Document which services use which variables
4. Provide examples for common configurations

## Action Items

1. ✅ Create updated .env with proper sections
2. ✅ Remove/deprecate Python LLM service variables
3. ✅ Add Shannon API configuration section
4. ✅ Update comments to reflect new architecture
5. ✅ Verify desktop .env files are consistent
6. ✅ Add migration guide comments for upgrading users
7. ⚠️ Investigate if agent-core actually uses LLM_SERVICE_URL
8. ⚠️ Update docker-compose.yml if agent-core needs to call shannon-api

## Desktop App Configuration Status

Both desktop config files are **already correct**:
- They point to `http://localhost:8080` which is now shannon-api
- No changes needed for desktop .env files
- The Tauri app will connect to the unified Rust API

## Critical Questions to Resolve

1. **Does agent-core actually call LLM_SERVICE_URL?**
   - If yes: Update to point to shannon-api
   - If no: Remove the variable

2. **Should we keep legacy variables for backward compatibility?**
   - Recommend: Comment them out with deprecation notices

3. **What's the migration story for existing deployments?**
   - Need to document the upgrade path clearly
