# .env Migration Guide - Architecture Update

## Overview

Shannon has migrated from a Python LLM service + Go gateway architecture to a unified Rust `shannon-api` service. This guide explains the changes needed to your `.env` file.

## Key Changes

### Architecture Before
```
Client → Go Gateway (8080) → Python LLM Service (8000) → Providers
                           ↓
                    Go Orchestrator (50052)
                           ↓
                    Rust Agent Core (50051)
```

### Architecture After
```
Client → Rust Shannon API (8080) → Providers
                ↓
         Go Orchestrator (50052)
                ↓
         Rust Agent Core (50051)
```

## Required Changes

### 1. Update Service References

**REMOVE** (deprecated Python service):
```bash
SERVICE_NAME=shannon-llm-service
OTEL_SERVICE_NAME=shannon-llm-service
```

**ADD** (new Rust service - optional, has defaults):
```bash
# Shannon API Configuration (Rust)
SHANNON_API_HOST=0.0.0.0
SHANNON_API_PORT=8080
SHANNON_API_ADMIN_PORT=8081
RUST_LOG=info
```

### 2. Update LLM Service URL

**CRITICAL**: The `agent-core` service uses `LLM_SERVICE_URL` to call tool execution endpoints.

**BEFORE** (pointed to Python service):
```bash
LLM_SERVICE_URL=http://llm-service:8000
```

**AFTER** (point to shannon-api):
```bash
# Shannon API provides LLM and tool execution services
# Used by agent-core for tool execution
LLM_SERVICE_URL=http://shannon-api:8080
```

### 3. Desktop App Configuration

**No changes needed!** Desktop apps already point to the correct port:
- `desktop/.env.local`: `NEXT_PUBLIC_API_URL=http://localhost:8080` ✅
- `desktop/.env.production`: `NEXT_PUBLIC_API_URL=http://localhost:8080` ✅

### 4. Port Mapping Reference

| Service | Port | Purpose |
|---------|------|---------|
| shannon-api | 8080 | Main API (Gateway + LLM) |
| shannon-api | 8082 | Admin/Metrics (mapped from internal 8081) |
| orchestrator | 50052 | gRPC |
| orchestrator | 8081 | Admin/Events |
| agent-core | 50051 | gRPC |
| agent-core | 2113 | Metrics |

## Variables That Stay The Same

✅ All LLM provider API keys (OPENAI_API_KEY, ANTHROPIC_API_KEY, etc.)
✅ Database configuration (POSTGRES_*)
✅ Redis configuration (REDIS_*)
✅ Qdrant configuration (QDRANT_*)
✅ Web search/fetch configuration
✅ Temporal configuration
✅ Orchestrator configuration
✅ Security variables (JWT_SECRET, GATEWAY_SKIP_AUTH)
✅ Tool execution settings
✅ WASI sandbox configuration

## Legacy Service Support

The old Python LLM service and Go gateway are still available via Docker profiles:

```bash
# Start with legacy services (for backward compatibility)
docker compose --profile legacy up -d
```

This starts:
- `llm-service` on port 8001 (mapped from 8000)
- `gateway` on port 8083 (mapped from 8080)

## Migration Checklist

- [ ] Update `LLM_SERVICE_URL` to point to `shannon-api:8080`
- [ ] Remove `SERVICE_NAME` and `OTEL_SERVICE_NAME` (or update for shannon-api)
- [ ] Optionally add `SHANNON_API_*` variables (has sensible defaults)
- [ ] Verify desktop app still connects to `http://localhost:8080`
- [ ] Test that agent-core can execute tools via shannon-api
- [ ] Update any custom scripts that reference old service names

## Verification Steps

After updating your `.env`:

1. **Start services**:
   ```bash
   make dev
   # or
   docker compose -f deploy/compose/docker-compose.yml up -d
   ```

2. **Check shannon-api health**:
   ```bash
   curl http://localhost:8080/health
   ```

3. **Verify agent-core can reach shannon-api**:
   ```bash
   docker compose logs agent-core | grep -i "llm_service"
   ```

4. **Test task submission**:
   ```bash
   curl -X POST http://localhost:8080/api/v1/tasks \
     -H "Content-Type: application/json" \
     -d '{"query": "What is 2+2?", "session_id": "test"}'
   ```

## Troubleshooting

### Issue: agent-core can't connect to LLM service
**Solution**: Verify `LLM_SERVICE_URL=http://shannon-api:8080` in `.env`

### Issue: Desktop app shows connection error
**Solution**: Ensure shannon-api is running on port 8080:
```bash
docker compose ps shannon-api
curl http://localhost:8080/health
```

### Issue: Missing provider API keys
**Solution**: Shannon-api needs at least one provider API key:
```bash
OPENAI_API_KEY=sk-...
# or
ANTHROPIC_API_KEY=sk-ant-...
```

## Rollback Plan

If you need to use the old architecture:

1. Revert `LLM_SERVICE_URL=http://llm-service:8000`
2. Start with legacy profile:
   ```bash
   docker compose --profile legacy up -d
   ```
3. Update desktop app to point to gateway:
   ```bash
   # desktop/.env.local
   NEXT_PUBLIC_API_URL=http://localhost:8083
   ```

## Questions?

- Check the [Rust Architecture docs](../docs/rust-architecture.md)
- Review [docker-compose.yml](../deploy/compose/docker-compose.yml) for service definitions
- Open an issue on GitHub
