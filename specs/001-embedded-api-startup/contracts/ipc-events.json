{
  "title": "Shannon Embedded API Server IPC Events Contract",
  "version": "1.0.0",
  "description": "Tauri IPC event definitions for embedded API server startup and communication",
  "events": {
    "server-state-change": {
      "description": "Emitted when embedded server state changes during startup, operation, or recovery",
      "frequency": "On state transitions",
      "payload": {
        "type": "object",
        "required": ["from", "to", "timestamp", "port"],
        "properties": {
          "from": {
            "type": "string",
            "enum": ["idle", "starting", "port-discovery", "binding", "initializing", "ready", "running", "crashed", "failed", "restarting"],
            "description": "Previous server state"
          },
          "to": {
            "type": "string",
            "enum": ["idle", "starting", "port-discovery", "binding", "initializing", "ready", "running", "crashed", "failed", "restarting"],
            "description": "New server state"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp of state change"
          },
          "port": {
            "type": ["integer", "null"],
            "minimum": 1906,
            "maximum": 1915,
            "description": "Port number if available, null during discovery"
          },
          "base_url": {
            "type": ["string", "null"],
            "pattern": "^http://127\\.0\\.0\\.1:[0-9]+$",
            "description": "Complete server URL when available"
          },
          "error": {
            "type": ["string", "null"],
            "description": "Error message if state change due to failure"
          },
          "restart_attempt": {
            "type": ["integer", "null"],
            "minimum": 1,
            "maximum": 3,
            "description": "Current restart attempt number if restarting"
          },
          "next_retry_delay_ms": {
            "type": ["integer", "null"],
            "description": "Milliseconds until next restart attempt"
          }
        }
      },
      "example": {
        "from": "starting",
        "to": "ready",
        "timestamp": "2026-01-09T10:30:00.000Z",
        "port": 1906,
        "base_url": "http://127.0.0.1:1906",
        "error": null,
        "restart_attempt": null,
        "next_retry_delay_ms": null
      }
    },

    "server-log": {
      "description": "Real-time log events from embedded API server for debug console",
      "frequency": "High (potentially >100/second)",
      "payload": {
        "type": "object",
        "required": ["timestamp", "level", "component", "message"],
        "properties": {
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "ISO 8601 timestamp of log event"
          },
          "level": {
            "type": "string",
            "enum": ["error", "warn", "info", "debug", "trace"],
            "description": "Log level"
          },
          "component": {
            "type": "string",
            "enum": ["embedded-api", "http-server", "database", "llm-client", "workflow-engine", "auth", "ipc", "health-check"],
            "description": "Source component that generated the log"
          },
          "message": {
            "type": "string",
            "maxLength": 1000,
            "description": "Human-readable log message"
          },
          "context": {
            "type": "object",
            "additionalProperties": {
              "type": "string"
            },
            "description": "Optional structured context data"
          },
          "error": {
            "type": ["object", "null"],
            "properties": {
              "type": { "type": "string" },
              "message": { "type": "string" },
              "stack": { "type": ["string", "null"] }
            },
            "description": "Detailed error information if log level is error"
          },
          "duration_ms": {
            "type": ["integer", "null"],
            "description": "Operation duration in milliseconds for performance tracking"
          }
        }
      },
      "example": {
        "timestamp": "2026-01-09T10:30:15.123Z",
        "level": "info",
        "component": "embedded-api",
        "message": "Server bound successfully to port 1906",
        "context": {
          "attempted_ports": "1906",
          "bind_duration_ms": "45"
        },
        "error": null,
        "duration_ms": 45
      }
    },

    "server-health": {
      "description": "Health check results for embedded API server monitoring",
      "frequency": "Every 30 seconds",
      "payload": {
        "type": "object",
        "required": ["endpoint", "status", "timestamp", "response_time_ms"],
        "properties": {
          "endpoint": {
            "type": "string",
            "enum": ["/health", "/ready", "/startup"],
            "description": "Health check endpoint that was tested"
          },
          "status": {
            "type": "string",
            "enum": ["healthy", "degraded", "unhealthy"],
            "description": "Overall health status"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "When health check was performed"
          },
          "response_time_ms": {
            "type": "integer",
            "minimum": 0,
            "maximum": 5000,
            "description": "Response time in milliseconds"
          },
          "details": {
            "type": "object",
            "properties": {
              "database": {
                "type": "object",
                "properties": {
                  "status": { "type": "string", "enum": ["healthy", "unhealthy"] },
                  "response_time_ms": { "type": "integer" }
                }
              },
              "llm_provider": {
                "type": "object",
                "properties": {
                  "status": { "type": "string", "enum": ["configured", "missing"] },
                  "provider": { "type": ["string", "null"] }
                }
              },
              "workflow_engine": {
                "type": "object",
                "properties": {
                  "status": { "type": "string", "enum": ["ready", "initializing", "failed"] }
                }
              }
            },
            "description": "Detailed health check results by component"
          }
        }
      },
      "example": {
        "endpoint": "/ready",
        "status": "healthy",
        "timestamp": "2026-01-09T10:30:30.000Z",
        "response_time_ms": 23,
        "details": {
          "database": {
            "status": "healthy",
            "response_time_ms": 5
          },
          "llm_provider": {
            "status": "configured",
            "provider": "openai"
          },
          "workflow_engine": {
            "status": "ready"
          }
        }
      }
    },

    "server-restart-attempt": {
      "description": "Emitted during server restart attempts with exponential backoff",
      "frequency": "During restart cycles only",
      "payload": {
        "type": "object",
        "required": ["attempt", "max_attempts", "success", "timestamp"],
        "properties": {
          "attempt": {
            "type": "integer",
            "minimum": 1,
            "maximum": 3,
            "description": "Current restart attempt number"
          },
          "max_attempts": {
            "type": "integer",
            "const": 3,
            "description": "Maximum allowed restart attempts"
          },
          "success": {
            "type": "boolean",
            "description": "Whether restart attempt was successful"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "When restart attempt was made"
          },
          "error": {
            "type": ["string", "null"],
            "description": "Error message if restart failed"
          },
          "next_delay_ms": {
            "type": ["integer", "null"],
            "description": "Milliseconds until next attempt (null if successful or no more attempts)"
          },
          "port": {
            "type": ["integer", "null"],
            "description": "Port used for restart attempt"
          }
        }
      },
      "example": {
        "attempt": 2,
        "max_attempts": 3,
        "success": false,
        "timestamp": "2026-01-09T10:32:00.000Z",
        "error": "Address already in use: 1906",
        "next_delay_ms": 4000,
        "port": 1906
      }
    }
  },

  "commands": {
    "get_server_status": {
      "description": "Get current embedded server status and configuration",
      "parameters": {
        "type": "object",
        "properties": {}
      },
      "returns": {
        "type": "object",
        "required": ["state", "port", "uptime_seconds", "restart_count"],
        "properties": {
          "state": {
            "type": "string",
            "enum": ["idle", "starting", "ready", "running", "failed", "restarting"]
          },
          "port": {
            "type": ["integer", "null"],
            "description": "Current port or null if not bound"
          },
          "base_url": {
            "type": ["string", "null"],
            "description": "Full server URL or null if not ready"
          },
          "uptime_seconds": {
            "type": "integer",
            "minimum": 0
          },
          "restart_count": {
            "type": "integer",
            "minimum": 0
          },
          "last_error": {
            "type": ["string", "null"]
          }
        }
      }
    },

    "get_recent_logs": {
      "description": "Retrieve recent log entries for debug console initialization",
      "parameters": {
        "type": "object",
        "properties": {
          "count": {
            "type": "integer",
            "minimum": 1,
            "maximum": 1000,
            "default": 100,
            "description": "Number of recent log entries to retrieve"
          },
          "level_filter": {
            "type": ["string", "null"],
            "enum": ["error", "warn", "info", "debug", "trace", null],
            "description": "Optional log level filter"
          }
        }
      },
      "returns": {
        "type": "array",
        "items": {
          "$ref": "#/events/server-log/payload"
        }
      }
    },

    "restart_embedded_server": {
      "description": "Manually trigger embedded server restart (admin function)",
      "parameters": {
        "type": "object",
        "properties": {
          "force": {
            "type": "boolean",
            "default": false,
            "description": "Force restart even if server is healthy"
          }
        }
      },
      "returns": {
        "type": "object",
        "properties": {
          "accepted": {
            "type": "boolean",
            "description": "Whether restart request was accepted"
          },
          "reason": {
            "type": ["string", "null"],
            "description": "Reason if restart was rejected"
          }
        }
      }
    }
  }
}