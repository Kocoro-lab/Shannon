# Shannon Orchestrator Configuration
# This file demonstrates the configuration system with hot-reload capability

service:
  port: 50052
  health_port: 8081
  graceful_timeout: "30s"
  read_timeout: "10s"
  write_timeout: "10s"
  max_header_bytes: 1048576

auth:
  enabled: true  # Set to true to enable authentication
  skip_auth: true # Development mode - bypasses auth checks
  jwt_secret: "change-this-to-a-secure-32-char-minimum-secret"
  access_token_expiry: "30m"
  refresh_token_expiry: "168h" # 7 days
  api_key_rate_limit: 1000
  default_tenant_limit: 10000
  enable_registration: true
  require_email_verification: false

circuit_breakers:
  redis:
    max_requests: 5
    interval: "30s"
    timeout: "60s"
    max_failures: 5
    on_state_change: true
    enabled: true
  database:
    max_requests: 3
    interval: "30s"
    timeout: "60s"
    max_failures: 3
    on_state_change: true
    enabled: true
  grpc:
    max_requests: 10
    interval: "30s"
    timeout: "60s"
    max_failures: 10
    on_state_change: true
    enabled: true

# MCP Tool Definitions (loaded at startup by llm-service)
mcp_tools:
  # Test tool for development (uses the mock endpoint)
  test_config_tool:
    enabled: true
    url: "http://localhost:8000/mcp/mock"
    func_name: "echo"
    description: "Test MCP tool loaded from config - UPDATED"
    category: "test"
    cost_per_use: 0.002
    parameters:
      - name: "message"
        type: "string"
        required: true
        description: "Message to echo"

  # Example: Gaode Maps API (uncomment to use)
  # gaode_maps:
  #   enabled: true
  #   url: "https://api.gaode.com/mcp"
  #   func_name: "geocode"
  #   description: "Gaode Maps geocoding service"
  #   category: "location"
  #   cost_per_use: 0.001
  #   parameters:
  #     - name: "address"
  #       type: "string"
  #       required: true
  #       description: "Address to geocode"
  #     - name: "city"
  #       type: "string"
  #       required: false
  #       description: "City for context"
  #   headers:  # Optional, use env refs for secrets
  #     X-API-Key: "${GAODE_API_KEY}"

degradation:
  enabled: true
  check_interval: "30s"
  thresholds:
    minor:
      circuit_breakers_open: 1
      critical_dependencies_down: 0
      non_critical_dependencies_down: 1
      error_rate_percentage: 5.0
      latency_threshold_ms: 1000
    moderate:
      circuit_breakers_open: 2
      critical_dependencies_down: 1
      non_critical_dependencies_down: 2
      error_rate_percentage: 15.0
      latency_threshold_ms: 2000
    severe:
      circuit_breakers_open: 3
      critical_dependencies_down: 2
      non_critical_dependencies_down: 3
      error_rate_percentage: 30.0
      latency_threshold_ms: 5000
  mode_downgrade:
    enabled: true
    minor_degradation_rules:
      complex_to_standard: true
      standard_to_simple: false
      complex_to_simple: false
      force_simple_mode: false
    moderate_degradation_rules:
      complex_to_standard: true
      standard_to_simple: true
      complex_to_simple: false
      force_simple_mode: false
    severe_degradation_rules:
      complex_to_standard: true
      standard_to_simple: true
      complex_to_simple: true
      force_simple_mode: true
  partial_results:
    enabled: true
    success_thresholds:
      simple: 1.0
      standard: 0.5
      complex: 0.6
      agent_dag: 0.4
    timeout_override: "5s"
    max_wait_time: "30s"
  fallback_behaviors:
    llm_generation: "cache"
    vector_search: "proceed"
    agent_execution: "degrade"
    result_synthesis: "proceed"
    session_update: "proceed"

health:
  enabled: true
  check_interval: "30s"
  timeout: "5s"
  port: 8081
  checks:
    redis:
      enabled: true
      critical: true
      timeout: "5s"
      interval: "30s"
    database:
      enabled: true
      critical: true
      timeout: "5s"
      interval: "30s"
    agent_core:
      enabled: true
      critical: true
      timeout: "5s"
      interval: "30s"
    llm_service:
      enabled: true
      critical: false
      timeout: "5s"
      interval: "60s"

agents:
  max_concurrent: 5
  default_timeout: "30s"
  health_check_port: 2113
  retry_count: 3
  retry_backoff: "2s"
  # Use service DNS names inside Docker compose network
  agent_core_endpoint: "agent-core:50051"
  llm_service_endpoint: "http://llm-service:8000"

policy:
  enabled: true
  mode: "dry-run"  # off, dry-run, enforce  
  path: "/app/config/opa/policies"
  fail_closed: false  # true = deny on policy failure, false = allow on failure
  environment: "staging"  # policy context environment
  audit:
    enabled: true
    log_level: "info"
    include_input: true
    include_decision: true

temporal:
  host_port: "localhost:7233"
  namespace: "default"
  task_queue: "shannon-task-queue"
  timeout: "30s"
  retry_policy:
    initial_interval: "1s"
    backoff_coefficient: 2.0
    maximum_interval: "100s"
    maximum_attempts: 10

logging:
  level: "info"
  development: false
  encoding: "json"
  output_paths:
    - "stdout"
  error_output_paths:
    - "stderr"

vector:
  enabled: true
  host: "qdrant"
  port: 6333
  task_embeddings: "task_embeddings"
  tool_results: "tool_results"
  cases: "cases"
  document_chunks: "document_chunks"
  top_k: 5
  threshold: 0.5
  timeout: "3s"
  default_model: "text-embedding-3-small"
  cache_ttl: "1h"
  use_redis_cache: true
  redis_addr: "redis:6379"

tracing:
  enabled: false  # Enable for development/staging environments
  service_name: "shannon-orchestrator"
  otlp_endpoint: "otel-collector:4317"

# Streaming configuration
streaming:
  ring_capacity: 256  # Number of recent events to retain per workflow for replay

# Workflow orchestration behavior
workflow:
  bypass_single_result: true  # Skip synthesis for single successful results

# Cognitive workflow configurations
cognitive_workflows:
  exploratory:
    max_iterations: 5
    confidence_threshold: 0.85
    branch_factor: 3
    max_concurrent_agents: 3
  react:
    max_iterations: 10
    observation_window: 3
  research:
    research_depth: 3
    sources_per_round: 4
    min_sources: 5
    max_concurrent_agents: 3
  scientific:
    max_hypotheses: 3
    max_iterations: 4
    confidence_threshold: 0.75
    contradiction_threshold: 0.3
