{{/*
  research_with_facts.tmpl - Research synthesis with structured fact extraction

  Use for: ResearchWorkflow with fact extraction enabled
  Style: Comprehensive report PLUS structured facts JSON appendix
  Enable: Set context.enable_fact_extraction = true

  Variables available:
    .Query              - Original user query
    .QueryLanguage      - Detected language of query
    .ResearchAreas      - []string of research areas to cover
    .AvailableCitations - Formatted citation list
    .CitationCount      - Number of available citations
    .MinCitations       - Minimum citations to use
    .LanguageInstruction - Language matching instruction
    .AgentResults       - Raw agent outputs for synthesis
    .TargetWords        - Target word count for detailed findings
    .CitationAgentEnabled - When true, do NOT add [n] markers
*/}}

{{- template "system_contract" . -}}

# Synthesis Requirements:

IMPORTANT: Do NOT include any of the Synthesis Requirements, Output Format, or Coverage Checklist text in the final answer. The final answer must contain ONLY the report sections, their content, AND the structured facts appendix.

## Coverage Checklist (DO NOT STOP until ALL are satisfied):
{{- if .ResearchAreas }}
✓ Each of the {{ len .ResearchAreas }} research areas has a dedicated subsection (### heading)
✓ Each subsection contains 150–250 words minimum
{{- end }}
✓ Executive Summary captures key insights (150–250 words)
{{- if gt .CitationCount 0 }}
{{- if .CitationAgentEnabled }}
✓ Focus on accurate content - citations will be added automatically
✓ Note conflicting information naturally
{{- else }}
✓ Each subsection includes ≥2 inline citations [n]
✓ ALL claims supported by Available Citations (no fabrication)
✓ Conflicting sources explicitly noted: "[1] says X, [2] says Y"
{{- end }}
{{- else }}
✓ If no sources are available, do NOT fabricate citations; mark unsupported claims as "unverified"
{{- end }}
✓ Response written in the SAME language as the query
✓ Structured Facts appendix contains all key factual claims

{{ template "language_instruction" . }}

{{- if gt .CitationCount 0 }}
{{- if .CitationAgentEnabled }}
## Citation Handling:
- DO NOT add any inline citations [n] to your response
- A separate Citation Agent will add citations after you finish
- Focus ONLY on producing accurate, well-organized content
- When referencing facts from sources, write naturally without citation markers
- Do NOT include a "## Sources" section; the system handles this automatically
{{- else }}
## Citation Integration:
- Use inline citations [1], [2] for ALL factual claims that have supporting sources
- Aim for AT LEAST {{ .MinCitations }} inline citations IF sufficient relevant sources exist
- Use ONLY the provided Available Citations and their existing indices [n]
- DO NOT cite irrelevant sources just to meet a quota
- If a research area lacks relevant citations, note explicitly: "Limited information available on [aspect]" rather than citing unrelated sources
- DO NOT invent new citation numbers; if a claim lacks a matching citation, flag as "unverified"
- Each unique URL gets ONE citation number only
- Do NOT include a "## Sources" section; the system will append Sources automatically
{{- end }}
{{- else }}
## Citation Guidance:
- Do NOT fabricate citations.
- If a claim lacks supporting sources, mark it as "unverified".
{{- end }}

## Preserve Source Integrity:
- Keep findings VERBATIM when referencing specific data/quotes
- Synthesize patterns across sources, but don't paraphrase individual claims

## Quantitative Synthesis Requirements:
- When data/numbers/metrics are available in agent results: CREATE MARKDOWN TABLES when appropriate
- Tables should compare: size, growth rates, market share, performance metrics, costs, timelines
{{- if not .CitationAgentEnabled }}
- Include inline citations [n] for ALL data points in tables
{{- end }}

## Output Format:

Use exactly these top-level headings in your response:

## Executive Summary
## Detailed Findings
## Limitations and Uncertainties (ONLY if significant gaps/conflicts exist)
## Structured Facts

Section requirements:
- Executive Summary: 150–250 words; capture key insights and conclusions
- Detailed Findings: {{ .TargetWords }}–{{ add .TargetWords 600 }} words total; organize by research areas
- Limitations and Uncertainties: 100–150 words IF evidence is incomplete; OMIT if well-supported
- Structured Facts: JSON array of extracted facts (see format below)

{{- if .ResearchAreas }}
## MANDATORY Research Area Coverage:
You MUST create a subsection for EACH of the {{ len .ResearchAreas }} research areas below.
{{- range .ResearchAreas }}
### {{ . }}
{{- end }}
{{- end }}

## Structured Facts Appendix Format:

After the main report, include a "## Structured Facts" section with a JSON code block:

```json
{
  "facts": [
    {
      "id": "fact-1",
      "statement": "Factual claim extracted from synthesis",
      "category": "funding|product|market|technical|team|partnership|regulatory|performance",
      "confidence": 0.95,
      "source_citations": [1, 3],
      "entities": ["Company X", "Product Y"],
      "temporal": "2024-Q2",
      "quantitative": true
    }
  ],
  "summary": {
    "total_facts": 15,
    "high_confidence": 12,
    "categories": {"funding": 3, "product": 5, "market": 4, "technical": 3}
  }
}
```

### Fact Extraction Guidelines:
- Extract 10-20 discrete, verifiable factual claims from the synthesis
- Each fact should be a single, atomic statement
- Assign confidence based on evidence quality: 0.9+ for multiple sources, 0.7-0.9 for single source
{{- if not .CitationAgentEnabled }}
- Include citation indices that support each fact
{{- end }}
- Categories: funding, product, market, technical, team, partnership, regulatory, performance
- Mark quantitative facts (those with numbers, metrics, percentages) as quantitative: true
- Include temporal markers when dates/periods are mentioned

## Quality Standards:
{{- if .CitationAgentEnabled }}
- State findings CONFIDENTLY and AUTHORITATIVELY when well-supported by evidence
- DO NOT add unnecessary cautious disclaimers unless evidence is genuinely missing
- Present well-evidenced facts as definitive conclusions, not tentative observations
- Do NOT mention agents, tools, workflows, or internal retrieval; write directly to the user
- NEVER fabricate or hallucinate information
{{- else }}
- State findings CONFIDENTLY and AUTHORITATIVELY when well-supported by citations
- DO NOT add unnecessary cautious disclaimers unless evidence is genuinely missing
- Present well-cited facts as definitive conclusions, not tentative observations
- Do NOT mention agents, tools, workflows, or internal retrieval; write directly to the user
- NEVER fabricate or hallucinate sources
{{- end }}

{{ template "citation_list" . }}
