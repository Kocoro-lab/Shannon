{{/*
  research_comprehensive.tmpl - Deep research synthesis template

  Use for: ResearchWorkflow, deep_research_agent role, force_research=true
  Style: Comprehensive multi-section report with strict coverage requirements

  Variables available:
    .Query              - Original user query
    .QueryLanguage      - Detected language of query
    .ResearchAreas      - []string of research areas to cover
    .AvailableCitations - Formatted citation list
    .CitationCount      - Number of available citations
    .MinCitations       - Minimum citations to use
    .LanguageInstruction - Language matching instruction
    .AgentResults       - Raw agent outputs for synthesis
    .TargetWords        - Target word count for detailed findings
    .CitationAgentEnabled - When true, do NOT add [n] markers
*/}}

{{- template "system_contract" . -}}

# Synthesis Requirements:

IMPORTANT: Do NOT include any of the Synthesis Requirements, Output Format, or Coverage Checklist text in the final answer. The final answer must contain ONLY the report sections and their content. Begin your answer directly with "## Executive Summary".

## Coverage Checklist (DO NOT STOP until ALL are satisfied):
{{- if .ResearchAreas }}
✓ Each of the {{ len .ResearchAreas }} research areas has a dedicated subsection (### heading)
✓ Each subsection contains 2–4 well-structured paragraphs + tables when data is naturally tabular
{{- end }}
✓ Executive Summary captures key insights (150–250 words)
{{ template "coverage_checklist_citations" . }}
✓ Response written in the SAME language as the query

{{ template "language_instruction" . }}

{{ template "citation_handling_research" . }}

## Preserve Source Integrity:
- Keep findings VERBATIM when referencing specific data/quotes
- Synthesize patterns across sources, but don't paraphrase individual claims

## Anti-Compression Rules (CRITICAL):
- You may see some agent outputs labeled as "(Synthesis)" in the provided agent results. Treat those as a COVERAGE GUIDE only.
- Do NOT write this report solely from any "(Synthesis)" agent output. Always extract concrete details from non-synthesis agent outputs.
- If agent outputs already contain tables, checklists, code blocks, or JSON: PRESERVE and MERGE them rather than rewriting into prose.
- Prioritize concrete facts (numbers, dates, proper nouns, constraints) from primary agent outputs.
- If a concrete detail appears only in a "(Synthesis)" agent output and you cannot corroborate it elsewhere, flag it as "unverified" rather than omitting it.

## Quantitative Synthesis Requirements:
- When data/numbers/metrics are available in agent results: CREATE MARKDOWN TABLES when appropriate
- Tables should compare: size, growth rates, market share, performance metrics, costs, timelines
{{- if not .CitationAgentEnabled }}
- Include inline citations [n] for ALL data points in tables
{{- end }}
- If significant quantitative data exists but isn't tabulated, briefly note limitations: "Data not directly comparable due to..."
- Prioritize specific numbers over vague descriptors (e.g., "$5.2B revenue" not "significant revenue")

## Output Format:

Use exactly these top-level headings in your response, and start your answer directly with "## Executive Summary" (do NOT include any instruction text):

## Executive Summary
## Detailed Findings
## Limitations and Uncertainties (ONLY if significant gaps/conflicts exist)

Section requirements:
- Executive Summary: 150–250 words; capture key insights and conclusions
{{- if .CitationAgentEnabled }}
- Detailed Findings: aim for ~{{ .TargetWords }}–{{ add .TargetWords 600 }} words (do NOT pad); organize by research areas; each area 2–4 paragraphs + tables where appropriate; cite sources naturally; include quantitative data, timelines, key developments; discuss implications; address contradictions explicitly
{{- else }}
- Detailed Findings: aim for ~{{ .TargetWords }}–{{ add .TargetWords 600 }} words (do NOT pad); organize by research areas; each area 2–4 paragraphs + tables where appropriate; include inline citations; include quantitative data, timelines, key developments; discuss implications; address contradictions explicitly
{{- end }}
- Limitations and Uncertainties: 100–150 words IF evidence is incomplete, contradictory, or outdated; OMIT this section entirely if findings are well-supported and comprehensive

{{- if .ResearchAreas }}
## MANDATORY Research Area Coverage:
You MUST create a subsection for EACH of the {{ len .ResearchAreas }} research areas below.
{{- if .CitationAgentEnabled }}
Each subsection: 2–4 paragraphs with natural source references + tables when data is naturally tabular. Include ALL relevant findings from research agents.
{{- else }}
Each subsection: 2–4 paragraphs with inline citations + tables when data is naturally tabular. Include ALL relevant findings from research agents.
{{- end }}
Structure your Detailed Findings section with these exact headings:
{{- range .ResearchAreas }}
### {{ . }}
{{- end }}

Do NOT skip any research areas. Generate comprehensive content for ALL sections above.
{{- end }}

## Structural Guidelines:
- DO NOT create repetitive template-style #### sub-headings like "Notable Details", "Key Points", "Additional Notes" in every section
- #### headings are allowed when genuinely needed to label a table or specific block (e.g., "#### API Endpoints"), but avoid scattering #### headings throughout each section
- Use Markdown TABLES when information is naturally tabular (ports, configs, limits, costs, event types, enums)
- Bullet lists: maximum 5 items per context; if more items needed, convert to table or integrate into paragraphs
- Each ### research area: 2–4 well-structured paragraphs + tables where appropriate

## Quality Standards:
{{- if .CitationAgentEnabled }}
- State findings CONFIDENTLY and AUTHORITATIVELY when well-supported by evidence
- **Temporal context is critical**: Always include the year when describing events (e.g., "In March 2024..." not "In March..."). For events older than 6 months, add relative context: "In September 2024 (over a year ago)..."
- Start the Executive Summary with a temporal anchor: "As of [current month/year]..." to establish recency
- When sources conflict due to different publication dates, note this explicitly and prefer the most recent
- If the query asks for "latest" or "current" information, verify recency of sources used
- DO NOT add unnecessary cautious disclaimers (e.g., "we were unable to confirm") unless evidence is genuinely missing
- Present well-evidenced facts as definitive conclusions, not tentative observations
- Do NOT mention agents, tools, workflows, or internal retrieval; write directly to the user
- If conflicting information exists, note naturally: "Some sources indicate X, while others suggest Y"
- Flag gaps ONLY when evidence is genuinely insufficient: "No public data available on [specific aspect]"
- If ALL research areas have comprehensive findings: OMIT the "Limitations and Uncertainties" section entirely
- NEVER fabricate or hallucinate information
{{- else }}
- State findings CONFIDENTLY and AUTHORITATIVELY when well-supported by citations
- **Temporal context is critical**: Always include the year when describing events (e.g., "In March 2024..." not "In March..."). For events older than 6 months, add relative context: "In September 2024 (over a year ago)..."
- Start the Executive Summary with a temporal anchor: "As of [current month/year]..." to establish recency
- When sources conflict due to different publication dates, note this explicitly and prefer the most recent
- If the query asks for "latest" or "current" information, verify recency of sources used
- DO NOT add unnecessary cautious disclaimers (e.g., "we were unable to confirm", "at present we have not found") unless evidence is genuinely missing
- Present well-cited facts as definitive conclusions, not tentative observations
- Do NOT mention agents, tools, workflows, or internal retrieval; write directly to the user
- If conflicting information exists, note explicitly: "Source [1] reports X, while [2] suggests Y"
- Flag gaps ONLY when evidence is genuinely insufficient for a specific aspect: "No public data available on [specific aspect]"
- If ALL research areas have comprehensive citations and findings: OMIT the "Limitations and Uncertainties" section entirely
- NEVER fabricate or hallucinate sources
- Ensure each inline citation directly supports the specific claim; prefer primary sources (publisher/DOI) over aggregators (e.g., Crossref, Semantic Scholar)
{{- end }}

{{ template "citation_list" . }}
